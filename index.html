<!DOCTYPE html>
<html lang="pt-BR" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ERP Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Inicialização do Tailwind CSS (mantida no head para evitar FOUC)
        const initTailwind = () => {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    darkMode: 'class',
                    theme: {
                        extend: {
                            colors: {
                                slate: { 850: '#1e293b', 950: '#020617' }
                            }
                        }
                    }
                };
            } else {
                setTimeout(initTailwind, 50);
            }
        };
        initTailwind();
    </script>
    <!-- Bibliotecas via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Biblioteca para manipulação de datas (melhoria de robustez) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <!-- Ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Critical Fixes -->
    <script src="fixes.js" defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .trans-all { transition: all 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* Chat Styles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        .chat-user { background-color: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f1f5f9; border: 1px solid #e2e8f0; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        .dark .chat-ai { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }
        .dark .chat-ai strong { color: #818cf8; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 8px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(120%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; border-left: 4px solid; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }
        .toast-info { border-color: #3b82f6; }
        .dark .toast { background: #1e293b; color: white; }

        /* Animation */
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .btn-shine { background: linear-gradient(to right, #4f46e5 20%, #818cf8 40%, #818cf8 60%, #4f46e5 80%); background-size: 200% auto; animation: shine 4s linear infinite; }

        /* Print CSS - O Mágico do PDF */
        @media print {
            aside, header, #ai-chat-panel, .no-print { display: none !important; }
            body, main { overflow: visible !important; height: auto !important; background: white !important; color: black !important; }
            .card, .bg-white { box-shadow: none !important; border: 1px solid #ddd !important; break-inside: avoid; }
            #view-dashboard { display: block !important; padding: 0 !important; }
            /* Ajuste para caber gráficos na folha */
            canvas { max-height: 250px !important; } 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-950 dark:text-gray-100 trans-all overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- API Key Modal -->
    <div id="api-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-96 transform scale-95 transition-transform" id="api-modal-content">
            <h3 class="text-xl font-bold mb-2">Configurar IA</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Insira sua chave do Google Gemini para ativar o consultor inteligente.</p>
            <input type="password" id="api-key-input" placeholder="Cole sua chave AIza..." class="w-full p-3 border border-gray-300 dark:border-slate-700 rounded-lg mb-4 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" aria-label="Chave da API Gemini" autocomplete="off">
            <div id="api-key-status" class="text-xs mb-4 hidden"></div>
            <div class="flex justify-end gap-2">
                <button onclick="closeApiModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button onclick="saveApiKey()" id="save-api-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salvar</button>
            </div>
            <p class="text-xs text-center mt-4 text-gray-400">A chave fica salva apenas no seu navegador.</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[450px] max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Configurações</h3>
                <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Limites de Validação -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Limites de Validação</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">Valor Mínimo (R$)</label>
                        <input type="number" id="config-min-value" step="0.01" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Valor Máximo (R$)</label>
                        <input type="number" id="config-max-value" step="0.01" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                </div>
            </div>

            <!-- Limite de Arquivo -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Upload de Arquivo</h4>
                <div>
                    <label class="text-xs text-gray-500">Tamanho Máximo (MB)</label>
                    <input type="number" id="config-max-file" step="1" min="1" max="100" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                </div>
            </div>

            <!-- Previsão -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Previsão</h4>
                <div>
                    <label class="text-xs text-gray-500">Dias de Previsão</label>
                    <select id="config-forecast-days" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                        <option value="7">7 dias</option>
                        <option value="14">14 dias</option>
                        <option value="30">30 dias</option>
                    </select>
                </div>
            </div>

            <!-- Dados -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Gerenciar Dados</h4>
                <button onclick="clearAllData(); closeSettingsModal(); location.reload();" class="w-full px-4 py-2 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                    <i class="fa-solid fa-trash mr-2"></i> Limpar Todos os Dados
                </button>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-slate-700">
                <button onclick="closeSettingsModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-96">
            <h3 class="text-xl font-bold mb-4">Exportar Dados</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Escolha o formato de exportação:</p>
            <div class="space-y-3">
                <button onclick="exportToCSV(); closeExportModal();" class="w-full flex items-center gap-3 p-3 border border-gray-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors">
                    <i class="fa-solid fa-file-csv text-green-600 text-xl"></i>
                    <div class="text-left">
                        <p class="font-medium">CSV</p>
                        <p class="text-xs text-gray-500">Arquivo separado por vírgula</p>
                    </div>
                </button>
                <button onclick="exportToExcel(); closeExportModal();" class="w-full flex items-center gap-3 p-3 border border-gray-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors">
                    <i class="fa-solid fa-file-excel text-emerald-600 text-xl"></i>
                    <div class="text-left">
                        <p class="font-medium">Excel</p>
                        <p class="text-xs text-gray-500">Planilha com resumo e dados</p>
                    </div>
                </button>
                <button onclick="exportToPDF(); closeExportModal();" class="w-full flex items-center gap-3 p-3 border border-gray-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors">
                    <i class="fa-solid fa-file-pdf text-red-600 text-xl"></i>
                    <div class="text-left">
                        <p class="font-medium">PDF</p>
                        <p class="text-xs text-gray-500">Relatório formatado para impressão</p>
                    </div>
                </button>
            </div>
            <button onclick="closeExportModal()" class="w-full mt-4 px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[600px] max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold">Selecione o Tipo de Dados</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Escolha o template que melhor descreve seus dados</p>
                </div>
                <button onclick="closeTemplateModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6" id="template-options">
                <!-- Vendas -->
                <button onclick="selectTemplate('vendas')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-indigo-500 dark:hover:border-indigo-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                            <i class="fa-solid fa-cart-shopping"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-indigo-600 dark:group-hover:text-indigo-400">Vendas</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Transações, produtos, categorias, pagamentos</p>
                </button>

                <!-- Estoque -->
                <button onclick="selectTemplate('estoque')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-emerald-500 dark:hover:border-emerald-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                            <i class="fa-solid fa-boxes-stacked"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-emerald-600 dark:group-hover:text-emerald-400">Estoque</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Inventário, movimentações, entradas e saídas</p>
                </button>

                <!-- Finanças -->
                <button onclick="selectTemplate('financas')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-green-500 dark:hover:border-green-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center text-green-600 dark:text-green-400">
                            <i class="fa-solid fa-wallet"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-green-600 dark:group-hover:text-green-400">Finanças</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Receitas, despesas, contas a pagar/receber</p>
                </button>

                <!-- Jurídico -->
                <button onclick="selectTemplate('juridico')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-amber-500 dark:hover:border-amber-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center text-amber-600 dark:text-amber-400">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-amber-600 dark:group-hover:text-amber-400">Jurídico</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Processos, contratos, prazos, honorários</p>
                </button>

                <!-- Educação -->
                <button onclick="selectTemplate('educacao')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-purple-500 dark:hover:border-purple-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center text-purple-600 dark:text-purple-400">
                            <i class="fa-solid fa-graduation-cap"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-purple-600 dark:group-hover:text-purple-400">Educação</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Alunos, matrículas, notas, frequência</p>
                </button>

                <!-- Personalizado -->
                <button onclick="selectTemplate('custom')" class="template-card p-4 border-2 border-gray-200 dark:border-slate-700 rounded-xl hover:border-slate-500 dark:hover:border-slate-400 transition-all text-left group">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center text-slate-600 dark:text-slate-400">
                            <i class="fa-solid fa-sliders"></i>
                        </div>
                        <h4 class="font-semibold group-hover:text-slate-600 dark:group-hover:text-slate-400">Personalizado</h4>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Configure manualmente suas colunas</p>
                </button>
            </div>

            <div class="text-center">
                <button onclick="closeTemplateModal()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    Cancelar importação
                </button>
            </div>
        </div>
    </div>

    <!-- Column Mapping Modal -->
    <div id="mapping-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[700px] max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold">Mapeamento de Colunas</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="mapping-template-name">Template: Vendas</p>
                </div>
                <button onclick="closeMappingModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Preview dos dados -->
            <div class="mb-4 p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Preview dos seus dados (primeiras 3 linhas):</p>
                <div class="overflow-x-auto">
                    <table class="text-xs w-full" id="data-preview-table">
                        <!-- Preenchido dinamicamente -->
                    </table>
                </div>
            </div>

            <!-- Mapeamento -->
            <div class="space-y-3" id="mapping-fields">
                <!-- Preenchido dinamicamente baseado no template -->
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-slate-700">
                <button onclick="closeMappingModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    Voltar
                </button>
                <button onclick="applyMapping()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fa-solid fa-check mr-2"></i>Aplicar e Importar
                </button>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Modal -->
    <div id="filters-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[500px] max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Filtros Avançados</h3>
                <button onclick="closeFiltersModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Período Personalizado -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Período</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">Data Inicial</label>
                        <input type="date" id="filter-date-start" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Data Final</label>
                        <input type="date" id="filter-date-end" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                </div>
            </div>

            <!-- Categoria -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Categoria</h4>
                <select id="filter-category" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    <option value="">Todas as categorias</option>
                </select>
            </div>

            <!-- Produto -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Produto</h4>
                <select id="filter-product" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    <option value="">Todos os produtos</option>
                </select>
            </div>

            <!-- Método de Pagamento -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Método de Pagamento</h4>
                <select id="filter-payment" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    <option value="">Todos os métodos</option>
                </select>
            </div>

            <!-- Status -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Status</h4>
                <select id="filter-status" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    <option value="">Todos os status</option>
                </select>
            </div>

            <!-- Faixa de Valor -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Faixa de Valor</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">Valor Mínimo</label>
                        <input type="number" id="filter-value-min" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Valor Máximo</label>
                        <input type="number" id="filter-value-max" step="0.01" placeholder="999999.99" class="w-full p-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white">
                    </div>
                </div>
            </div>

            <!-- Filtros Ativos -->
            <div id="active-filters-summary" class="mb-4 hidden">
                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                    <p class="text-xs font-medium text-indigo-700 dark:text-indigo-300" id="active-filters-text"></p>
                </div>
            </div>

            <div class="flex justify-between gap-2 pt-4 border-t border-gray-200 dark:border-slate-700">
                <button onclick="clearAdvancedFilters()" class="px-4 py-2 text-red-600 hover:text-red-700 dark:text-red-400">
                    <i class="fa-solid fa-times mr-1"></i> Limpar Filtros
                </button>
                <div class="flex gap-2">
                    <button onclick="closeFiltersModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                    <button onclick="applyAdvancedFilters()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Aplicar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        
        <!-- SIDEBAR -->
        <aside class="w-20 md:w-64 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col flex-shrink-0 z-20 trans-all shadow-lg print:hidden">
            <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-gray-100 dark:border-slate-800">
                <div class="flex items-center gap-3 text-indigo-600 dark:text-indigo-400 font-bold text-xl">
                    <i class="fa-solid fa-layer-group text-2xl"></i>
                    <span class="hidden md:block">Nexus ERP</span>
                </div>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-xl trans-all group active-nav">
                    <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Visão Geral</span>
                </button>
                
                <button onclick="switchView('forecast')" id="nav-forecast" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600 dark:hover:text-purple-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-crystal-ball text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Previsões Futuras</span>
                </button>

                <button onclick="toggleChatPanel()" class="w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-robot text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Consultor IA</span>
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100 dark:border-slate-800">
                <div class="bg-indigo-50 dark:bg-slate-800 p-4 rounded-xl hidden md:block">
                    <p class="text-xs font-semibold text-indigo-900 dark:text-indigo-200 mb-1">Status do Sistema</p>
                    <div class="flex items-center gap-2 text-green-600 dark:text-green-400 text-xs font-bold">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        Online
                    </div>
                </div>
                <button onclick="showKeyboardShortcuts()" class="w-full mt-2 p-2 text-xs text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-800 rounded-lg trans-all hidden md:flex items-center justify-center gap-2">
                    <i class="fa-regular fa-keyboard"></i>
                    <span>Atalhos</span>
                    <kbd class="px-1.5 py-0.5 bg-gray-200 dark:bg-slate-700 rounded text-[10px]">?</kbd>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 relative">
            
            <!-- TOP BAR -->
            <header class="h-auto md:h-16 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 flex flex-col md:flex-row items-center justify-between px-6 py-2 md:py-0 trans-all z-10 gap-2 print:hidden">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-gray-700 dark:text-gray-100 hidden md:block">Visão Geral</h2>

                    <!-- Indicador de Template Atual -->
                    <button onclick="showTemplateSelector()" id="current-template-badge" class="hidden md:flex items-center gap-2 px-3 py-1 text-xs font-medium rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors" title="Clique para trocar template">
                        <i class="fa-solid fa-cart-shopping"></i>
                        <span id="template-badge-text">Vendas</span>
                        <i class="fa-solid fa-chevron-down text-[10px] opacity-50"></i>
                    </button>

                    <!-- FILTROS DE DATA -->
                    <div class="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-1">
                        <button onclick="filterByDate(7)" id="btn-7d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700 shadow-sm">7 Dias</button>
                        <button onclick="filterByDate(30)" id="btn-30d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700">30 Dias</button>
                        <button onclick="filterByDate('all')" id="btn-all" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm">Todos</button>
                    </div>

                    <!-- Filtros Avançados -->
                    <button onclick="openFiltersModal()" id="btn-advanced-filters" class="flex items-center gap-1 px-3 py-1 text-xs font-medium rounded-lg border border-gray-300 dark:border-slate-600 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:border-indigo-400 hover:text-indigo-600 trans-all" title="Filtros Avançados">
                        <i class="fa-solid fa-filter"></i>
                        <span class="hidden sm:inline">Filtros</span>
                        <span id="filter-badge" class="hidden w-4 h-4 bg-indigo-600 text-white text-[10px] rounded-full flex items-center justify-center">0</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Settings -->
                    <button onclick="openSettingsModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-800 trans-all" title="Configurações">
                        <i class="fa-solid fa-sliders"></i>
                    </button>

                    <!-- Config API -->
                    <button onclick="openApiModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-800 trans-all" title="Configurar API Key">
                        <i class="fa-solid fa-key"></i>
                    </button>

                    <!-- Theme -->
                    <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-yellow-400 hover:ring-2 ring-indigo-500 trans-all" title="Alternar Tema">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </button>

                    <!-- Export -->
                    <button onclick="openExportModal()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 trans-all" title="Exportar Dados">
                        <i class="fa-solid fa-download"></i>
                    </button>

                    <!-- Data Load -->
                    <div class="relative flex gap-2">
                        <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileUpload(this)" class="hidden" aria-label="Selecionar arquivo CSV">
                        <button onclick="document.getElementById('csv-file-input').click()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 trans-all">
                            <i class="fa-solid fa-file-csv mr-1"></i> CSV
                        </button>
                        <button onclick="loadSampleData()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 dark:bg-slate-700 dark:text-gray-200 dark:hover:bg-slate-600 trans-all">
                            <i class="fa-solid fa-flask mr-1"></i> Demo
                        </button>
                    </div>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 scrollbar-hide">
                
                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="view-panel grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- KPIs -->
                    <div class="lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800 hover:shadow-xl trans-all cursor-pointer" onclick="openFiltersModal()">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Receita Total</p>
                            <h3 id="kpi-revenue" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mt-1">R$ 0,00</h3>
                            <p id="kpi-revenue-trend" class="text-xs mt-1 flex items-center gap-1">
                                <span class="text-gray-400">0 registros</span>
                            </p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800 hover:shadow-xl trans-all cursor-pointer" onclick="openFiltersModal()">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Volume de Vendas</p>
                            <h3 id="kpi-sales" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0</h3>
                            <p id="kpi-sales-trend" class="text-xs mt-1 flex items-center gap-1">
                                <span class="text-gray-400">Total de transações</span>
                            </p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800 hover:shadow-xl trans-all cursor-pointer" onclick="openFiltersModal()">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Ticket Médio</p>
                            <h3 id="kpi-ticket" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mt-1">R$ 0,00</h3>
                            <p id="kpi-ticket-trend" class="text-xs mt-1 flex items-center gap-1">
                                <span class="text-gray-400">Média por transação</span>
                            </p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800 hover:shadow-xl trans-all cursor-pointer" onclick="openFiltersModal()">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Top Categoria</p>
                            <h3 id="kpi-category" class="text-2xl font-bold text-pink-600 dark:text-pink-400 mt-1">-</h3>
                            <p id="kpi-category-share" class="text-xs text-gray-400 mt-1">Em volume de vendas</p>
                        </div>
                    </div>

                    <!-- GRÁFICO DE LINHA - Vendas Diárias -->
                    <div class="lg:col-span-3 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Tendência de Vendas Diárias <span id="sales-trend-filter" class="text-base font-normal text-gray-500 dark:text-gray-400"></span></h4>
                            <button onclick="analyzeSpecificChart('sales_trend')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE DONUT - Status dos Pedidos -->
                    <div class="lg:col-span-1 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Status dos Pedidos</h4>
                            <button onclick="analyzeSpecificChart('order_status')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80 flex items-center justify-center">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE BARRA - Desempenho por Categoria -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Desempenho por Categoria (R$)</h4>
                            <button onclick="analyzeSpecificChart('category_performance')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE BARRA - Métodos de Pagamento -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Métodos de Pagamento (Qtd)</h4>
                            <button onclick="analyzeSpecificChart('payment_methods')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="paymentChart"></canvas>
                        </div>
                    </div>

                    <!-- TABELA - Top Produtos -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <h4 class="text-lg font-semibold mb-4">Top 5 Produtos</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsBody" class="bg-white dark:bg-slate-900 divide-y divide-gray-100 dark:divide-slate-800">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TABELA - Transações Recentes -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <h4 class="text-lg font-semibold mb-4">Transações Recentes</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody" class="bg-white dark:bg-slate-900 divide-y divide-gray-100 dark:divide-slate-800">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- FORECAST VIEW -->
                <div id="view-forecast" class="view-panel hidden">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <h4 class="text-lg font-semibold mb-4" id="forecast-title">Previsão de Vendas (Próximos 7 Dias)</h4>
                            
                            <!-- Filtros de Previsão -->
                            <div class="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-1 mb-4 w-fit">
                                <button onclick="updateForecastView('general')" data-type="general" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-300 shadow-sm">Geral</button>
                                <button onclick="updateForecastView('categories')" data-type="categories" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Categoria</button>
                                <button onclick="updateForecastView('payments')" data-type="payments" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Pagamento</button>
                                <button onclick="updateForecastView('status')" data-type="status" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Status</button>
                            </div>

                            <div class="h-96">
                                <canvas id="forecastChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- AI CHAT PANEL -->
        <div id="ai-chat-panel" class="fixed right-0 top-0 h-full w-80 bg-white dark:bg-slate-900 shadow-2xl z-30 transform translate-x-full transition-transform duration-300 flex flex-col print:hidden">
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-slate-800">
                <h3 class="text-lg font-bold text-blue-600 dark:text-blue-400"><i class="fa-solid fa-robot mr-2"></i> Consultor IA</h3>
                <div class="flex items-center gap-2">
                    <button onclick="clearChatHistory()" class="text-gray-400 hover:text-red-500 trans-all" title="Limpar histórico">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                    <button onclick="toggleChatPanel()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="chat-history" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-3 scrollbar-hide">
                <div class="chat-bubble chat-ai">Olá! Sou o seu assistente de BI. Carregue seus dados e me pergunte sobre tendências, anomalias ou previsões.</div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-slate-800">
                <div class="flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="Pergunte sobre seus dados..." class="flex-1 p-3 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" aria-label="Campo de mensagem do chat" autocomplete="off">
                    <button onclick="sendChatMessage()" class="w-10 h-10 flex items-center justify-center bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Variáveis de estado globais
        let apiKey = localStorage.getItem('geminiApiKey') || 'SUA_CHAVE_AQUI';
        let fullData = [];
        let currentData = [];
        let stats = {};
        let timeSeriesData = {};
        const charts = {};
        let chartTheme = {};
        let currentView = 'dashboard';
        let lastValidation = null;
        let chatHistory = [];

        // Configurações do usuário (persistidas)
        let userConfig = {
            minValue: 0.01,
            maxValue: 10000000,
            maxFileSizeMB: 50,
            forecastDays: 7
        };

        // ==================== SISTEMA DE TEMPLATES ====================
        let currentTemplate = 'vendas';
        let pendingCSVData = null;
        let csvHeaders = [];
        let columnMapping = {};

        // Definição dos templates disponíveis
        const dataTemplates = {
            vendas: {
                name: 'Vendas',
                icon: 'fa-cart-shopping',
                color: 'indigo',
                fields: [
                    { key: 'date', label: 'Data', required: true, patterns: ['data', 'date', 'dt_venda', 'criado_em', 'time', 'data_venda'] },
                    { key: 'category', label: 'Categoria', required: false, patterns: ['categoria', 'category', 'cat', 'setor', 'grupo'] },
                    { key: 'product', label: 'Produto/Item', required: false, patterns: ['produto', 'product', 'item', 'mercadoria', 'nome', 'descrição'] },
                    { key: 'value', label: 'Valor', required: true, patterns: ['valor', 'value', 'total', 'price', 'preço', 'amount', 'venda'] },
                    { key: 'payment', label: 'Forma de Pagamento', required: false, patterns: ['pagamento', 'payment', 'pgto', 'forma', 'metodo'] },
                    { key: 'status', label: 'Status', required: false, patterns: ['status', 'estado', 'situacao', 'situação'] }
                ],
                kpis: ['Receita Total', 'Volume de Vendas', 'Ticket Médio', 'Top Categoria'],
                charts: ['line', 'bar', 'doughnut', 'payment']
            },
            estoque: {
                name: 'Estoque',
                icon: 'fa-boxes-stacked',
                color: 'emerald',
                fields: [
                    { key: 'date', label: 'Data', required: true, patterns: ['data', 'date', 'dt_movimentacao', 'data_mov'] },
                    { key: 'product', label: 'Produto', required: true, patterns: ['produto', 'product', 'item', 'sku', 'codigo'] },
                    { key: 'category', label: 'Categoria', required: false, patterns: ['categoria', 'category', 'grupo', 'tipo'] },
                    { key: 'value', label: 'Quantidade', required: true, patterns: ['quantidade', 'qtd', 'qty', 'quant', 'unidades'] },
                    { key: 'payment', label: 'Tipo Movimentação', required: false, patterns: ['tipo', 'movimentacao', 'entrada', 'saida', 'operacao'] },
                    { key: 'status', label: 'Armazém/Local', required: false, patterns: ['armazem', 'local', 'deposito', 'estoque', 'loja'] }
                ],
                kpis: ['Total Itens', 'Movimentações', 'Média Diária', 'Top Produto'],
                charts: ['line', 'bar', 'doughnut', 'payment'],
                valueLabel: 'Quantidade',
                valuePrefix: ''
            },
            financas: {
                name: 'Finanças',
                icon: 'fa-wallet',
                color: 'green',
                fields: [
                    { key: 'date', label: 'Data', required: true, patterns: ['data', 'date', 'vencimento', 'dt_lancamento', 'competencia'] },
                    { key: 'category', label: 'Categoria/Centro de Custo', required: false, patterns: ['categoria', 'category', 'centro_custo', 'conta', 'tipo'] },
                    { key: 'product', label: 'Descrição', required: false, patterns: ['descricao', 'description', 'historico', 'observacao', 'item'] },
                    { key: 'value', label: 'Valor', required: true, patterns: ['valor', 'value', 'total', 'amount', 'montante'] },
                    { key: 'payment', label: 'Tipo (Receita/Despesa)', required: false, patterns: ['tipo', 'natureza', 'receita', 'despesa', 'classificacao'] },
                    { key: 'status', label: 'Status', required: false, patterns: ['status', 'situacao', 'pago', 'pendente', 'estado'] }
                ],
                kpis: ['Saldo Total', 'Receitas', 'Despesas', 'Balanço'],
                charts: ['line', 'bar', 'doughnut', 'payment']
            },
            juridico: {
                name: 'Jurídico',
                icon: 'fa-scale-balanced',
                color: 'amber',
                fields: [
                    { key: 'date', label: 'Data', required: true, patterns: ['data', 'date', 'dt_entrada', 'abertura', 'distribuicao'] },
                    { key: 'category', label: 'Área/Tipo', required: false, patterns: ['area', 'tipo', 'materia', 'natureza', 'categoria'] },
                    { key: 'product', label: 'Processo/Contrato', required: false, patterns: ['processo', 'contrato', 'numero', 'caso', 'cliente'] },
                    { key: 'value', label: 'Valor da Causa/Honorário', required: true, patterns: ['valor', 'value', 'honorario', 'causa', 'montante'] },
                    { key: 'payment', label: 'Fase/Instância', required: false, patterns: ['fase', 'instancia', 'etapa', 'andamento', 'tribunal'] },
                    { key: 'status', label: 'Status', required: false, patterns: ['status', 'situacao', 'estado', 'resultado', 'conclusao'] }
                ],
                kpis: ['Valor em Causas', 'Total Processos', 'Média por Processo', 'Top Área'],
                charts: ['line', 'bar', 'doughnut', 'payment']
            },
            educacao: {
                name: 'Educação',
                icon: 'fa-graduation-cap',
                color: 'purple',
                fields: [
                    { key: 'date', label: 'Data', required: true, patterns: ['data', 'date', 'dt_matricula', 'periodo', 'semestre'] },
                    { key: 'category', label: 'Curso/Turma', required: false, patterns: ['curso', 'turma', 'classe', 'serie', 'disciplina'] },
                    { key: 'product', label: 'Aluno/Matrícula', required: false, patterns: ['aluno', 'estudante', 'matricula', 'nome', 'ra'] },
                    { key: 'value', label: 'Nota/Valor', required: true, patterns: ['nota', 'valor', 'mensalidade', 'score', 'media', 'frequencia'] },
                    { key: 'payment', label: 'Tipo (Avaliação/Pagamento)', required: false, patterns: ['tipo', 'avaliacao', 'prova', 'pagamento', 'forma'] },
                    { key: 'status', label: 'Status', required: false, patterns: ['status', 'situacao', 'aprovado', 'reprovado', 'cursando'] }
                ],
                kpis: ['Total Alunos', 'Média Geral', 'Taxa Aprovação', 'Top Curso'],
                charts: ['line', 'bar', 'doughnut', 'payment']
            },
            custom: {
                name: 'Personalizado',
                icon: 'fa-sliders',
                color: 'slate',
                fields: [
                    { key: 'date', label: 'Data/Período', required: true, patterns: [] },
                    { key: 'category', label: 'Agrupamento Principal', required: false, patterns: [] },
                    { key: 'product', label: 'Item/Descrição', required: false, patterns: [] },
                    { key: 'value', label: 'Valor Numérico', required: true, patterns: [] },
                    { key: 'payment', label: 'Agrupamento Secundário', required: false, patterns: [] },
                    { key: 'status', label: 'Status/Classificação', required: false, patterns: [] }
                ],
                kpis: ['Total', 'Quantidade', 'Média', 'Top Item'],
                charts: ['line', 'bar', 'doughnut', 'payment']
            }
        };

        // Funções do sistema de templates
        function openTemplateModal() {
            document.getElementById('template-modal').classList.remove('hidden');
        }

        function closeTemplateModal(clearData = true) {
            document.getElementById('template-modal').classList.add('hidden');
            if (clearData) {
                pendingCSVData = null;
                csvHeaders = [];
            }
        }

        function selectTemplate(templateKey) {
            currentTemplate = templateKey;
            closeTemplateModal(false); // Não limpar dados ao selecionar template
            openMappingModal();
        }

        function openMappingModal() {
            const template = dataTemplates[currentTemplate];
            document.getElementById('mapping-template-name').textContent = `Template: ${template.name}`;

            // Preencher preview dos dados
            const previewTable = document.getElementById('data-preview-table');
            if (pendingCSVData && pendingCSVData.length > 0) {
                const headers = csvHeaders;
                const previewRows = pendingCSVData.slice(0, 3);

                previewTable.innerHTML = `
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-slate-600">
                            ${headers.map(h => `<th class="px-2 py-1 text-left font-medium text-gray-700 dark:text-gray-300">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewRows.map(row => `
                            <tr class="border-b border-gray-100 dark:border-slate-700">
                                ${headers.map(h => `<td class="px-2 py-1 text-gray-600 dark:text-gray-400">${row[h] || '-'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                `;
            }

            // Preencher campos de mapeamento
            const mappingFields = document.getElementById('mapping-fields');
            mappingFields.innerHTML = '';

            template.fields.forEach(field => {
                // Auto-detectar coluna baseado nos patterns
                let autoDetected = '';
                for (const header of csvHeaders) {
                    const headerLower = header.toLowerCase();
                    if (field.patterns.some(p => headerLower.includes(p.toLowerCase()))) {
                        autoDetected = header;
                        break;
                    }
                }

                // Criar div do campo
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'flex items-center gap-4 p-3 bg-gray-50 dark:bg-slate-800 rounded-lg';

                // Criar label
                const labelDiv = document.createElement('div');
                labelDiv.className = 'w-1/3';
                labelDiv.innerHTML = `
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        ${field.label}
                        ${field.required ? '<span class="text-red-500">*</span>' : ''}
                    </label>
                `;

                // Criar select
                const selectDiv = document.createElement('div');
                selectDiv.className = 'w-2/3';

                const select = document.createElement('select');
                select.id = `map-${field.key}`;
                select.className = 'w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 dark:text-white text-sm focus:ring-2 focus:ring-indigo-500';

                // Adicionar opção padrão
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Selecione a coluna --';
                select.appendChild(defaultOption);

                // Adicionar opções de colunas
                csvHeaders.forEach(h => {
                    const option = document.createElement('option');
                    option.value = h;
                    option.textContent = h;
                    if (h === autoDetected) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                selectDiv.appendChild(select);
                fieldDiv.appendChild(labelDiv);
                fieldDiv.appendChild(selectDiv);
                mappingFields.appendChild(fieldDiv);
            });

            document.getElementById('mapping-modal').classList.remove('hidden');
        }

        function closeMappingModal() {
            document.getElementById('mapping-modal').classList.add('hidden');
        }

        function applyMapping() {
            const template = dataTemplates[currentTemplate];
            columnMapping = {};

            // Coletar mapeamento
            template.fields.forEach(field => {
                const select = document.getElementById(`map-${field.key}`);
                if (select && select.value) {
                    columnMapping[field.key] = select.value;
                }
            });

            // Validar campos obrigatórios
            const missingRequired = template.fields
                .filter(f => f.required && !columnMapping[f.key])
                .map(f => f.label);

            if (missingRequired.length > 0) {
                showToast(`Campos obrigatórios: ${missingRequired.join(', ')}`, 'error');
                return;
            }

            // Função auxiliar para normalizar datas
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const str = String(dateStr).trim();

                // Tentar formato ISO primeiro
                let dt = luxon.DateTime.fromISO(str);
                if (dt.isValid) return dt.toISODate();

                // Tentar formato brasileiro dd/MM/yyyy
                dt = luxon.DateTime.fromFormat(str, 'dd/MM/yyyy');
                if (dt.isValid) return dt.toISODate();

                // Tentar formato dd-MM-yyyy
                dt = luxon.DateTime.fromFormat(str, 'dd-MM-yyyy');
                if (dt.isValid) return dt.toISODate();

                // Tentar formato yyyy/MM/dd
                dt = luxon.DateTime.fromFormat(str, 'yyyy/MM/dd');
                if (dt.isValid) return dt.toISODate();

                // Tentar formato MM/dd/yyyy (americano)
                dt = luxon.DateTime.fromFormat(str, 'MM/dd/yyyy');
                if (dt.isValid) return dt.toISODate();

                return null;
            };

            // Função para normalizar valores numéricos
            const parseValue = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                // Remove R$, espaços, pontos de milhar e troca vírgula por ponto
                const cleaned = String(val)
                    .replace(/[R$\s]/g, '')
                    .replace(/\./g, '')
                    .replace(',', '.');
                return parseFloat(cleaned) || 0;
            };

            // Transformar dados
            const transformedData = pendingCSVData.map(row => ({
                date: parseDate(row[columnMapping.date]) || '',
                category: String(row[columnMapping.category] || 'Geral').trim(),
                product: String(row[columnMapping.product] || 'Item').trim(),
                value: parseValue(row[columnMapping.value]),
                payment: String(row[columnMapping.payment] || 'Outros').trim(),
                status: String(row[columnMapping.status] || 'Concluído').trim()
            }));

            // Validar os dados transformados
            const validation = DatasetValidator.validate(transformedData, {
                minValue: userConfig.minValue,
                maxValue: userConfig.maxValue
            });

            closeMappingModal();

            // Salvar template selecionado
            localStorage.setItem('nexus_template', currentTemplate);
            updateDashboardLabels();

            if (validation.valid.length > 0) {
                showValidationReport(validation);
                processData(validation.valid);
                showToast(`${validation.valid.length} registros importados!`, 'success');
            } else {
                showToast('Nenhum registro válido encontrado! Verifique o formato das datas e valores.', 'error');
            }

            pendingCSVData = null;
            csvHeaders = [];
        }

        function updateDashboardLabels() {
            const template = dataTemplates[currentTemplate];

            // Atualizar títulos dos KPIs baseado no template
            const kpiLabels = document.querySelectorAll('.card p.text-sm');
            if (kpiLabels.length >= 4 && template.kpis) {
                // Os labels dos KPIs são os primeiros 4 elementos com essa classe
                const kpiElements = Array.from(kpiLabels).slice(0, 4);
                kpiElements.forEach((el, i) => {
                    if (template.kpis[i]) {
                        el.textContent = template.kpis[i];
                    }
                });
            }

            // Atualizar ícone e cor do sidebar
            const logoIcon = document.querySelector('aside .fa-layer-group, aside .fa-cart-shopping, aside .fa-boxes-stacked, aside .fa-wallet, aside .fa-scale-balanced, aside .fa-graduation-cap, aside .fa-sliders');
            if (logoIcon && template.icon) {
                logoIcon.className = `fa-solid ${template.icon} text-2xl`;
            }

            // Atualizar badge do template no header
            const badge = document.getElementById('current-template-badge');
            const badgeIcon = badge?.querySelector('i:first-child');
            const badgeText = document.getElementById('template-badge-text');

            if (badge && badgeIcon && badgeText) {
                badgeIcon.className = `fa-solid ${template.icon}`;
                badgeText.textContent = template.name;

                // Atualizar cor do badge baseado no template
                const colorClasses = {
                    vendas: 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/50',
                    estoque: 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-900/50',
                    financas: 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900/50',
                    juridico: 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-900/50',
                    educacao: 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-900/50',
                    custom: 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'
                };

                // Remover cores anteriores e aplicar nova
                badge.className = badge.className.replace(/bg-\w+-\d+|text-\w+-\d+|hover:bg-\w+-\d+|dark:bg-\w+-\d+\/\d+|dark:text-\w+-\d+|dark:hover:bg-\w+-\d+\/\d+/g, '').trim();
                badge.className = `hidden md:flex items-center gap-2 px-3 py-1 text-xs font-medium rounded-lg transition-colors ${colorClasses[currentTemplate] || colorClasses.vendas}`;
            }
        }

        function showTemplateSelector() {
            // Cria um modal rápido para trocar o template
            const existingModal = document.getElementById('quick-template-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'quick-template-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Estilos pré-definidos para cada template (evita problemas com Tailwind JIT)
            const templateStyles = {
                vendas: {
                    border: 'border-indigo-500',
                    bg: 'bg-indigo-50 dark:bg-indigo-900/20',
                    iconBg: 'bg-indigo-100 dark:bg-indigo-900/30',
                    iconColor: 'text-indigo-600 dark:text-indigo-400',
                    hover: 'hover:border-indigo-500'
                },
                estoque: {
                    border: 'border-emerald-500',
                    bg: 'bg-emerald-50 dark:bg-emerald-900/20',
                    iconBg: 'bg-emerald-100 dark:bg-emerald-900/30',
                    iconColor: 'text-emerald-600 dark:text-emerald-400',
                    hover: 'hover:border-emerald-500'
                },
                financas: {
                    border: 'border-green-500',
                    bg: 'bg-green-50 dark:bg-green-900/20',
                    iconBg: 'bg-green-100 dark:bg-green-900/30',
                    iconColor: 'text-green-600 dark:text-green-400',
                    hover: 'hover:border-green-500'
                },
                juridico: {
                    border: 'border-amber-500',
                    bg: 'bg-amber-50 dark:bg-amber-900/20',
                    iconBg: 'bg-amber-100 dark:bg-amber-900/30',
                    iconColor: 'text-amber-600 dark:text-amber-400',
                    hover: 'hover:border-amber-500'
                },
                educacao: {
                    border: 'border-purple-500',
                    bg: 'bg-purple-50 dark:bg-purple-900/20',
                    iconBg: 'bg-purple-100 dark:bg-purple-900/30',
                    iconColor: 'text-purple-600 dark:text-purple-400',
                    hover: 'hover:border-purple-500'
                },
                custom: {
                    border: 'border-slate-500',
                    bg: 'bg-slate-50 dark:bg-slate-800/50',
                    iconBg: 'bg-slate-100 dark:bg-slate-800',
                    iconColor: 'text-slate-600 dark:text-slate-400',
                    hover: 'hover:border-slate-500'
                }
            };

            const templateOptions = Object.entries(dataTemplates).map(([key, t]) => {
                const isActive = key === currentTemplate;
                const style = templateStyles[key] || templateStyles.custom;

                const borderClass = isActive ? `${style.border} ${style.bg}` : 'border-gray-200 dark:border-slate-700';

                return `
                    <button onclick="changeTemplate('${key}')" class="p-3 border-2 ${borderClass} rounded-xl ${style.hover} transition-all text-left group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 ${style.iconBg} rounded-lg flex items-center justify-center ${style.iconColor}">
                                <i class="fa-solid ${t.icon}"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm">${t.name}</h4>
                                ${isActive ? '<p class="text-[10px] text-green-600 dark:text-green-400"><i class="fa-solid fa-check mr-1"></i>Ativo</p>' : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[400px]" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Alterar Template</h3>
                        <button onclick="document.getElementById('quick-template-modal').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Selecione o tipo de dados que você está analisando:</p>
                    <div class="grid grid-cols-2 gap-3">
                        ${templateOptions}
                    </div>
                    <p class="text-xs text-gray-400 mt-4 text-center">O template define os rótulos e métricas do dashboard</p>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function changeTemplate(templateKey) {
            if (dataTemplates[templateKey]) {
                currentTemplate = templateKey;
                localStorage.setItem('nexus_template', templateKey);
                updateDashboardLabels();
                document.getElementById('quick-template-modal')?.remove();
                showToast(`Template alterado para: ${dataTemplates[templateKey].name}`, 'success');
            }
        }

        // ==================== INDEXEDDB - PERSISTÊNCIA ====================
        const DB_NAME = 'NexusERP_DB';
        const DB_VERSION = 1;
        let db = null;

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    // Store para dados de vendas
                    if (!database.objectStoreNames.contains('salesData')) {
                        database.createObjectStore('salesData', { keyPath: 'id', autoIncrement: true });
                    }

                    // Store para histórico do chat
                    if (!database.objectStoreNames.contains('chatHistory')) {
                        database.createObjectStore('chatHistory', { keyPath: 'id', autoIncrement: true });
                    }

                    // Store para configurações
                    if (!database.objectStoreNames.contains('config')) {
                        database.createObjectStore('config', { keyPath: 'key' });
                    }
                };
            });
        }

        async function saveDataToDB(data) {
            if (!db) await openDatabase();

            if (!data || data.length === 0) {
                console.warn('Tentativa de salvar dados vazios no IndexedDB');
                return;
            }

            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction(['salesData'], 'readwrite');
                    const store = transaction.objectStore('salesData');

                    // Limpa dados antigos
                    const clearRequest = store.clear();

                    clearRequest.onsuccess = () => {
                        // Salva novos dados em lotes para melhor performance
                        let count = 0;
                        const batchSize = 100;

                        const addBatch = (startIndex) => {
                            const endIndex = Math.min(startIndex + batchSize, data.length);
                            for (let i = startIndex; i < endIndex; i++) {
                                store.add(data[i]);
                                count++;
                            }

                            if (endIndex < data.length) {
                                // Continua com próximo lote
                                setTimeout(() => addBatch(endIndex), 0);
                            }
                        };

                        addBatch(0);
                    };

                    clearRequest.onerror = () => {
                        console.error('Erro ao limpar dados:', clearRequest.error);
                        reject(clearRequest.error);
                    };

                    transaction.oncomplete = () => {
                        showToast('Dados salvos automaticamente!', 'success');
                        resolve();
                    };

                    transaction.onerror = () => {
                        console.error('Erro na transação:', transaction.error);
                        reject(transaction.error);
                    };

                    transaction.onabort = () => {
                        console.error('Transação abortada');
                        reject(new Error('Transação abortada'));
                    };
                } catch (error) {
                    console.error('Erro ao salvar dados:', error);
                    reject(error);
                }
            });
        }

        async function loadDataFromDB() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['salesData'], 'readonly');
                const store = transaction.objectStore('salesData');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveChatHistory() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['chatHistory'], 'readwrite');
                const store = transaction.objectStore('chatHistory');
                store.clear();
                chatHistory.forEach(msg => store.add(msg));
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        async function loadChatHistory() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['chatHistory'], 'readonly');
                const store = transaction.objectStore('chatHistory');
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveConfig() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['config'], 'readwrite');
                const store = transaction.objectStore('config');
                store.put({ key: 'userConfig', value: userConfig });
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        async function loadConfig() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['config'], 'readonly');
                const store = transaction.objectStore('config');
                const request = store.get('userConfig');

                request.onsuccess = () => {
                    if (request.result) userConfig = request.result.value;
                    resolve(userConfig);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function clearAllData() {
            if (!db) await openDatabase();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['salesData', 'chatHistory'], 'readwrite');
                transaction.objectStore('salesData').clear();
                transaction.objectStore('chatHistory').clear();
                fullData = [];
                currentData = [];
                chatHistory = [];
                transaction.oncomplete = () => {
                    showToast('Todos os dados foram limpos!', 'info');
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ==================== EXPORTAÇÃO DE DADOS ====================
        function exportToCSV() {
            if (!currentData.length) return showToast('Nenhum dado para exportar!', 'error');

            const headers = ['Data', 'Categoria', 'Produto', 'Valor', 'Pagamento', 'Status'];
            const rows = currentData.map(d => [
                d.date,
                d.category,
                d.product,
                d.value.toFixed(2),
                d.payment,
                d.status
            ]);

            const csvContent = [headers, ...rows].map(row => row.join(';')).join('\n');
            downloadFile(csvContent, `nexus_export_${luxon.DateTime.now().toFormat('yyyy-MM-dd_HHmm')}.csv`, 'text/csv;charset=utf-8;');
            showToast('CSV exportado com sucesso!', 'success');
        }

        function exportToExcel() {
            if (!currentData.length) return showToast('Nenhum dado para exportar!', 'error');

            // Gera HTML table que Excel consegue abrir
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            let html = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head><meta charset="UTF-8"></head>
                <body>
                <h2>Nexus ERP - Relatório de Vendas</h2>
                <p>Gerado em: ${luxon.DateTime.now().toFormat('dd/MM/yyyy HH:mm')}</p>
                <h3>Resumo</h3>
                <table border="1">
                    <tr><td><b>Receita Total</b></td><td>${fmt.format(stats.revenue)}</td></tr>
                    <tr><td><b>Total de Vendas</b></td><td>${stats.sales}</td></tr>
                    <tr><td><b>Ticket Médio</b></td><td>${fmt.format(stats.avgTicket)}</td></tr>
                    <tr><td><b>Top Categoria</b></td><td>${stats.topCategory}</td></tr>
                </table>
                <h3>Dados Detalhados</h3>
                <table border="1">
                    <tr><th>Data</th><th>Categoria</th><th>Produto</th><th>Valor</th><th>Pagamento</th><th>Status</th></tr>
                    ${currentData.map(d => `<tr><td>${d.date}</td><td>${d.category}</td><td>${d.product}</td><td>${fmt.format(d.value)}</td><td>${d.payment}</td><td>${d.status}</td></tr>`).join('')}
                </table>
                </body></html>
            `;

            downloadFile(html, `nexus_export_${luxon.DateTime.now().toFormat('yyyy-MM-dd_HHmm')}.xls`, 'application/vnd.ms-excel');
            showToast('Excel exportado com sucesso!', 'success');
        }

        function exportToPDF() {
            if (!currentData.length) return showToast('Nenhum dado para exportar!', 'error');

            // Abre janela de impressão otimizada para PDF
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Nexus ERP - Relatório</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #4f46e5; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #4f46e5; color: white; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .summary { display: flex; gap: 20px; margin-bottom: 20px; }
                        .summary-card { background: #f3f4f6; padding: 15px; border-radius: 8px; flex: 1; }
                        .summary-card h3 { margin: 0; font-size: 14px; color: #666; }
                        .summary-card p { margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #4f46e5; }
                    </style>
                </head>
                <body>
                    <h1>Nexus ERP Analytics - Relatório</h1>
                    <p>Gerado em: ${luxon.DateTime.now().toFormat('dd/MM/yyyy HH:mm')}</p>
                    <div class="summary">
                        <div class="summary-card"><h3>Receita Total</h3><p>${fmt.format(stats.revenue)}</p></div>
                        <div class="summary-card"><h3>Vendas</h3><p>${stats.sales}</p></div>
                        <div class="summary-card"><h3>Ticket Médio</h3><p>${fmt.format(stats.avgTicket)}</p></div>
                    </div>
                    <h2>Top 10 Produtos</h2>
                    <table>
                        <tr><th>Produto</th><th>Qtd</th><th>Total</th></tr>
                        ${stats.topProducts.slice(0, 10).map(p => `<tr><td>${p.name}</td><td>${p.qty}</td><td>${fmt.format(p.total)}</td></tr>`).join('')}
                    </table>
                    <h2>Últimas Transações</h2>
                    <table>
                        <tr><th>Data</th><th>Produto</th><th>Valor</th><th>Status</th></tr>
                        ${currentData.slice(-20).reverse().map(d => `<tr><td>${d.date}</td><td>${d.product}</td><td>${fmt.format(d.value)}</td><td>${d.status}</td></tr>`).join('')}
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // ==================== PREVISÃO MELHORADA ====================
        function calculateAdvancedForecast(dates, values, days = 7) {
            const n = values.length;
            if (n < 3) return Array(days).fill(values[n - 1] || 0);

            // 1. Média Móvel Simples (SMA)
            const smaWindow = Math.min(7, Math.floor(n / 2));
            const sma = [];
            for (let i = 0; i < n; i++) {
                if (i < smaWindow - 1) {
                    sma.push(values[i]);
                } else {
                    const window = values.slice(i - smaWindow + 1, i + 1);
                    sma.push(window.reduce((a, b) => a + b, 0) / smaWindow);
                }
            }

            // 2. Detectar sazonalidade semanal (se houver dados suficientes)
            const weeklyPattern = Array(7).fill(0);
            const weeklyCount = Array(7).fill(0);

            dates.forEach((date, i) => {
                const dayOfWeek = luxon.DateTime.fromISO(date).weekday - 1; // 0-6
                weeklyPattern[dayOfWeek] += values[i];
                weeklyCount[dayOfWeek]++;
            });

            // Média por dia da semana
            const avgByDayOfWeek = weeklyPattern.map((sum, i) => weeklyCount[i] > 0 ? sum / weeklyCount[i] : 0);
            const overallAvg = values.reduce((a, b) => a + b, 0) / n;

            // Fator sazonal
            const seasonalFactor = avgByDayOfWeek.map(avg => overallAvg > 0 ? avg / overallAvg : 1);

            // 3. Regressão Linear na tendência (usando SMA para suavizar)
            const x = Array.from({ length: n }, (_, i) => i);
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = sma.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((a, i) => a + i * sma[i], 0);
            const sumXX = x.reduce((a, i) => a + i * i, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // 4. Gerar previsão
            const lastDate = luxon.DateTime.fromISO(dates[n - 1]);
            const forecast = [];

            for (let i = 1; i <= days; i++) {
                const futureDate = lastDate.plus({ days: i });
                const dayOfWeek = futureDate.weekday - 1;

                // Tendência linear + ajuste sazonal
                let predicted = slope * (n - 1 + i) + intercept;
                predicted *= seasonalFactor[dayOfWeek];

                // Garantir valor não negativo
                forecast.push(Math.max(0, predicted));
            }

            return forecast;
        }

        // ==================== VALIDAÇÃO DE API KEY ====================
        async function validateApiKey(key) {
            if (!key || key === 'SUA_CHAVE_AQUI' || key.length < 30) return false;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${encodeURIComponent(key)}`, {
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.error('Erro ao validar API key:', error);
                return false;
            }
        }

        // --- DATASET VALIDATOR CLASS ---
        class DatasetValidator {
            static validate(rawData, config = {}) {
                const map = DatasetValidator.mapColumns(rawData[0] ? Object.keys(rawData[0]) : []);
                const values = rawData.map(d => map.value ? parseFloat(d[map.value]) : parseFloat(d.valor || d.value || 0)).filter(v => !isNaN(v));
                
                // Estatísticas para Outliers
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const stdDev = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / values.length);
                const zScoreLimit = 3; // 3 desvios padrão

                const result = {
                    valid: [],
                    invalid: [],
                    warnings: [],
                    duplicates: [],
                    outliers: [],
                    summary: { total: rawData.length, valid: 0, invalid: 0, warnings: 0, successRate: '0%' }
                };

                const seen = new Set();
                const hasIdColumn = map.id || rawData[0]?.id;

                rawData.forEach((d, index) => {
                    const rowIndex = index + 1;
                    const errors = [];
                    const warnings = [];
                    
                    // 1. Normalização e Validação de Colunas
                    const dateStr = map.date ? d[map.date] : (d.data || d.date || d.Data);
                    let date = null;

                    if (dateStr) {
                        const str = String(dateStr).trim();

                        // Tentar diversos formatos de data
                        const formats = [
                            null, // ISO format (handled by fromISO)
                            'dd/MM/yyyy',
                            'dd-MM-yyyy',
                            'yyyy/MM/dd',
                            'MM/dd/yyyy',
                            'dd/MM/yy',
                            'yyyy-MM-dd'
                        ];

                        for (const fmt of formats) {
                            if (fmt === null) {
                                date = luxon.DateTime.fromISO(str);
                            } else {
                                date = luxon.DateTime.fromFormat(str, fmt);
                            }
                            if (date.isValid) break;
                        }
                    }
                    
                    const valueRaw = map.value ? d[map.value] : (d.valor || d.value || 0);
                    const value = parseFloat(valueRaw);

                    const normalized = {
                        date: (date && date.isValid) ? date.toISODate() : null,
                        category: map.category ? d[map.category] : (d.categoria || d.category || 'Geral'),
                        product: map.product ? d[map.product] : (d.produto || d.product || 'Item'),
                        value: isNaN(value) ? 0 : value,
                        payment: map.payment ? d[map.payment] : (d.pagamento || d.payment || 'Outros'),
                        status: map.status ? d[map.status] : (d.status || 'Concluído')
                    };

                    // 2. Validação de Data
                    if (!normalized.date) {
                        errors.push(`Data inválida ou não encontrada: "${dateStr}"`);
                    }

                    // 3. Validação de Valor
                    if (isNaN(normalized.value) || normalized.value <= (config.minValue || 0)) {
                        errors.push(`Valor inválido ou abaixo do mínimo (${config.minValue || 0}): "${valueRaw}"`);
                    } else if (config.maxValue && normalized.value > config.maxValue) {
                        errors.push(`Valor acima do máximo permitido (${config.maxValue}): "${valueRaw}"`);
                    }

                    // 4. Validação de Pagamento (se configurado)
                    if (config.allowedPayments && !config.allowedPayments.includes(normalized.payment)) {
                        warnings.push(`Método de pagamento não padrão: "${normalized.payment}"`);
                    }

                    // 5. Validação de Outlier (aviso)
                    if (stdDev > 0 && Math.abs(normalized.value - mean) / stdDev > zScoreLimit) {
                        warnings.push(`Valor atípico (Outlier) detectado: R$ ${normalized.value.toFixed(2)}`);
                        result.outliers.push({ rowIndex, original: d, value: normalized.value });
                    }

                    // 6. Validação de Duplicata (aviso)
                    const idValue = map.id ? d[map.id] : d.id;
                    const key = hasIdColumn ? `id-${idValue}` : `${normalized.date}-${normalized.product}-${normalized.value}`;
                    let isDuplicate = false;
                    if (seen.has(key)) {
                        isDuplicate = true;
                        warnings.push(`Registro duplicado (mesma data, produto e valor)`);
                        result.duplicates.push({ rowIndex, original: d });
                    }
                    seen.add(key);

                    // 7. Classificação
                    if (errors.length > 0) {
                        result.invalid.push({ rowIndex, original: d, errors });
                    } else if (isDuplicate) {
                        result.warnings.push({ rowIndex, original: d, warnings });
                    } else {
                        result.valid.push(normalized);
                        if (warnings.length > 0) {
                            result.warnings.push({ rowIndex, original: d, warnings });
                        }
                    }
                });

                // 8. Sumário
                result.summary.valid = result.valid.length;
                result.summary.invalid = result.invalid.length;
                result.summary.warnings = result.warnings.length + result.duplicates.length + result.outliers.length;
                const successRate = result.summary.total > 0 ? (result.summary.valid / result.summary.total) * 100 : 0;
                result.summary.successRate = `${successRate.toFixed(1)}%`;

                return result;
            }

            static mapColumns(headers) {
                return {
                    date: headers.find(h => /data|date|dt_venda|criado_em|time/i.test(h)) || null,
                    category: headers.find(h => /categoria|category|cat|setor|grupo/i.test(h)) || null,
                    product: headers.find(h => /produto|product|item|mercadoria|nome|descrição|cliente|customer/i.test(h)) || null,
                    value: headers.find(h => /valor|value|total|price|preço|amount|venda|custo/i.test(h)) || null,
                    payment: headers.find(h => /pagamento|payment|pgto|forma|metodo/i.test(h)) || null,
                    status: headers.find(h => /status|estado|situacao|situação/i.test(h)) || null,
                    id: headers.find(h => /^id$/i.test(h)) || null
                };
            }
        }

        // --- UTILS (Theme, Toast, API Key) ---
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            }
            updateChartsTheme(); // Chama a função de charts diretamente
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = '';
            if (type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-500"></i>';
            else if (type === 'error') icon = '<i class="fa-solid fa-circle-xmark text-red-500"></i>';
            else icon = '<i class="fa-solid fa-circle-info text-blue-500"></i>';

            // Sanitize message to prevent XSS
            const sanitizedMessage = String(message).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            toast.innerHTML = `${icon} <span class="text-sm">${sanitizedMessage}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function openApiModal() {
            const input = document.getElementById('api-key-input');
            if (input) {
                input.value = apiKey === 'SUA_CHAVE_AQUI' ? '' : apiKey;
            }
            const modal = document.getElementById('api-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeApiModal() {
            const modal = document.getElementById('api-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const btn = document.getElementById('save-api-btn');
            const status = document.getElementById('api-key-status');

            if (!input || !btn || !status) {
                showToast("Erro ao acessar elementos do modal", "error");
                return;
            }

            const newKey = input.value.trim();

            if (newKey) {
                // Validação básica de formato
                if (newKey.length < 30 || !/^[A-Za-z0-9_-]+$/.test(newKey)) {
                    showToast("Formato de chave inválido", "error");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Validando...';
                status.classList.remove('hidden', 'text-green-600', 'text-red-600');
                status.classList.add('text-gray-500');
                status.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-1"></i> Verificando chave...';

                try {
                    const isValid = await validateApiKey(newKey);

                    if (isValid) {
                        apiKey = newKey;
                        localStorage.setItem('geminiApiKey', newKey);
                        status.classList.remove('text-gray-500');
                        status.classList.add('text-green-600');
                        status.innerHTML = '<i class="fa-solid fa-check-circle mr-1"></i> Chave válida!';
                        showToast("Chave API validada e salva!", "success");
                        setTimeout(() => closeApiModal(), 1000);
                    } else {
                        status.classList.remove('text-gray-500');
                        status.classList.add('text-red-600');
                        status.innerHTML = '<i class="fa-solid fa-times-circle mr-1"></i> Chave inválida. Verifique e tente novamente.';
                        showToast("Chave API inválida!", "error");
                    }
                } catch (error) {
                    console.error('Erro ao validar chave:', error);
                    status.classList.remove('text-gray-500');
                    status.classList.add('text-red-600');
                    status.innerHTML = '<i class="fa-solid fa-times-circle mr-1"></i> Erro de conexão.';
                    showToast("Erro ao validar chave. Verifique sua conexão.", "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Salvar';
                }
            } else {
                apiKey = 'SUA_CHAVE_AQUI';
                localStorage.removeItem('geminiApiKey');
                showToast("Chave API removida.", "info");
                closeApiModal();
            }
        }

        // --- SETTINGS MODAL ---
        function openSettingsModal() {
            document.getElementById('config-min-value').value = userConfig.minValue;
            document.getElementById('config-max-value').value = userConfig.maxValue;
            document.getElementById('config-max-file').value = userConfig.maxFileSizeMB;
            document.getElementById('config-forecast-days').value = userConfig.forecastDays;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function saveSettings() {
            try {
                const minValue = parseFloat(document.getElementById('config-min-value').value);
                const maxValue = parseFloat(document.getElementById('config-max-value').value);
                const maxFile = parseInt(document.getElementById('config-max-file').value);
                const forecastDays = parseInt(document.getElementById('config-forecast-days').value);

                // Validações
                if (isNaN(minValue) || minValue < 0) {
                    showToast('Valor mínimo inválido', 'error');
                    return;
                }

                if (isNaN(maxValue) || maxValue <= minValue) {
                    showToast('Valor máximo deve ser maior que o mínimo', 'error');
                    return;
                }

                if (isNaN(maxFile) || maxFile < 1 || maxFile > 100) {
                    showToast('Tamanho de arquivo deve estar entre 1 e 100 MB', 'error');
                    return;
                }

                if (isNaN(forecastDays) || forecastDays < 1 || forecastDays > 90) {
                    showToast('Dias de previsão deve estar entre 1 e 90', 'error');
                    return;
                }

                userConfig.minValue = minValue;
                userConfig.maxValue = maxValue;
                userConfig.maxFileSizeMB = maxFile;
                userConfig.forecastDays = forecastDays;

                await saveConfig();
                showToast('Configurações salvas!', 'success');
                closeSettingsModal();

                // Atualiza previsão se estiver na view
                if (currentView === 'forecast') {
                    updateForecastView('general');
                }
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                showToast('Erro ao salvar configurações', 'error');
            }
        }

        // --- EXPORT MODAL ---
        function openExportModal() {
            if (!currentData.length) {
                showToast('Carregue dados primeiro para exportar!', 'info');
                return;
            }
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        // --- ADVANCED FILTERS ---
        let activeFilters = {
            dateStart: null,
            dateEnd: null,
            category: '',
            product: '',
            payment: '',
            status: '',
            valueMin: null,
            valueMax: null
        };

        function openFiltersModal() {
            if (!fullData.length) {
                showToast('Carregue dados primeiro!', 'info');
                return;
            }

            // Popula os selects com os dados disponíveis
            const categories = [...new Set(fullData.map(d => d.category))].sort();
            const products = [...new Set(fullData.map(d => d.product))].sort();
            const payments = [...new Set(fullData.map(d => d.payment))].sort();
            const statuses = [...new Set(fullData.map(d => d.status))].sort();

            const catSelect = document.getElementById('filter-category');
            catSelect.innerHTML = '<option value="">Todas as categorias</option>' +
                categories.map(c => `<option value="${c}" ${activeFilters.category === c ? 'selected' : ''}>${c}</option>`).join('');

            const prodSelect = document.getElementById('filter-product');
            prodSelect.innerHTML = '<option value="">Todos os produtos</option>' +
                products.map(p => `<option value="${p}" ${activeFilters.product === p ? 'selected' : ''}>${p}</option>`).join('');

            const paySelect = document.getElementById('filter-payment');
            paySelect.innerHTML = '<option value="">Todos os métodos</option>' +
                payments.map(p => `<option value="${p}" ${activeFilters.payment === p ? 'selected' : ''}>${p}</option>`).join('');

            const statusSelect = document.getElementById('filter-status');
            statusSelect.innerHTML = '<option value="">Todos os status</option>' +
                statuses.map(s => `<option value="${s}" ${activeFilters.status === s ? 'selected' : ''}>${s}</option>`).join('');

            // Define datas mínimas/máximas disponíveis
            const dates = fullData.map(d => d.date).sort();
            document.getElementById('filter-date-start').value = activeFilters.dateStart || '';
            document.getElementById('filter-date-end').value = activeFilters.dateEnd || '';
            document.getElementById('filter-value-min').value = activeFilters.valueMin || '';
            document.getElementById('filter-value-max').value = activeFilters.valueMax || '';

            document.getElementById('filters-modal').classList.remove('hidden');
        }

        function closeFiltersModal() {
            document.getElementById('filters-modal').classList.add('hidden');
        }

        function applyAdvancedFilters() {
            activeFilters = {
                dateStart: document.getElementById('filter-date-start').value || null,
                dateEnd: document.getElementById('filter-date-end').value || null,
                category: document.getElementById('filter-category').value,
                product: document.getElementById('filter-product').value,
                payment: document.getElementById('filter-payment').value,
                status: document.getElementById('filter-status').value,
                valueMin: parseFloat(document.getElementById('filter-value-min').value) || null,
                valueMax: parseFloat(document.getElementById('filter-value-max').value) || null
            };

            // Aplica filtros
            currentData = fullData.filter(d => {
                if (activeFilters.dateStart && d.date < activeFilters.dateStart) return false;
                if (activeFilters.dateEnd && d.date > activeFilters.dateEnd) return false;
                if (activeFilters.category && d.category !== activeFilters.category) return false;
                if (activeFilters.product && d.product !== activeFilters.product) return false;
                if (activeFilters.payment && d.payment !== activeFilters.payment) return false;
                if (activeFilters.status && d.status !== activeFilters.status) return false;
                if (activeFilters.valueMin !== null && d.value < activeFilters.valueMin) return false;
                if (activeFilters.valueMax !== null && d.value > activeFilters.valueMax) return false;
                return true;
            });

            // Conta filtros ativos
            const activeCount = Object.values(activeFilters).filter(v => v !== null && v !== '').length;
            const badge = document.getElementById('filter-badge');

            if (activeCount > 0) {
                badge.textContent = activeCount;
                badge.classList.remove('hidden');
                badge.classList.add('flex');
                document.getElementById('btn-advanced-filters').classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('flex');
                document.getElementById('btn-advanced-filters').classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
            }

            // Limpa filtros de data padrão
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                btn.classList.add('text-gray-600', 'dark:text-gray-300');
            });

            // Atualiza o texto do filtro
            document.getElementById('sales-trend-filter').innerText = activeCount > 0 ? `(${activeCount} filtro${activeCount > 1 ? 's' : ''} ativo${activeCount > 1 ? 's' : ''})` : '(Todos os Dados)';

            calculateStats();
            updateDashboardUI();
            closeFiltersModal();

            showToast(`Filtros aplicados! ${currentData.length} registros encontrados.`, 'success');
        }

        function clearAdvancedFilters() {
            activeFilters = {
                dateStart: null,
                dateEnd: null,
                category: '',
                product: '',
                payment: '',
                status: '',
                valueMin: null,
                valueMax: null
            };

            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-product').value = '';
            document.getElementById('filter-payment').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-value-min').value = '';
            document.getElementById('filter-value-max').value = '';

            const badge = document.getElementById('filter-badge');
            badge.classList.add('hidden');
            badge.classList.remove('flex');
            document.getElementById('btn-advanced-filters').classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');

            filterByDate('all');
            closeFiltersModal();
            showToast('Filtros limpos!', 'info');
        }

        // --- VALIDATION REPORT UI ---
        function showValidationReport(validation) {
            lastValidation = validation; // Salva para download
            const existingReport = document.getElementById('validation-report');
            if (existingReport) existingReport.remove();

            const report = document.createElement('div');
            report.id = 'validation-report';
            report.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm';
            
            report.innerHTML = `
                <div class="bg-white dark:bg-slate-900 p-0 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white z-10">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">Relatório de Validação</h2>
                                <p class="text-indigo-100 text-sm mt-1">Análise completa dos dados importados</p>
                            </div>
                            <button onclick="closeValidationReport()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total</p>
                            <p class="text-3xl font-bold text-gray-800 dark:text-white">${validation.summary.total}</p>
                        </div>
                        <div class="card bg-green-50 dark:bg-green-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-green-600">Válidos</p>
                            <p class="text-3xl font-bold text-green-700 dark:text-green-400">${validation.summary.valid}</p>
                        </div>
                        <div class="card bg-red-50 dark:bg-red-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-red-600">Inválidos</p>
                            <p class="text-3xl font-bold text-red-700 dark:text-red-400">${validation.summary.invalid}</p>
                        </div>
                        <div class="card bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-yellow-600">Avisos</p>
                            <p class="text-3xl font-bold text-yellow-700 dark:text-yellow-400">${validation.summary.warnings}</p>
                        </div>
                    </div>

                    <!-- Taxa de Sucesso -->
                    <div class="px-6 pb-4">
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-indigo-700 dark:text-indigo-300">Taxa de Aprovação</span>
                                <span class="text-2xl font-bold text-indigo-800 dark:text-indigo-200">${validation.summary.successRate}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-3">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-1000" style="width: ${validation.summary.successRate}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Erros -->
                    ${validation.invalid.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500 p-4 rounded">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-circle-xmark text-red-600 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-red-800 dark:text-red-300 mb-2">
                                            ${validation.invalid.length} Erro(s) Encontrado(s)
                                        </h3>
                                        <div class="space-y-2 max-h-48 overflow-y-auto">
                                            ${validation.invalid.slice(0, 5).map(row => `
                                                <div class="bg-white dark:bg-slate-800 p-3 rounded text-sm">
                                                    <p class="font-bold text-red-700 dark:text-red-400">Linha ${row.rowIndex}:</p>
                                                    <ul class="mt-1 space-y-1 text-red-600 dark:text-red-300">
                                                        ${row.errors.map(err => `<li class="text-xs">• ${err}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            `).join('')}
                                            ${validation.invalid.length > 5 ? `
                                                <p class="text-center text-xs text-gray-500 dark:text-gray-400 pt-2">
                                                    ... e mais ${validation.invalid.length - 5} erros
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Avisos -->
                    ${validation.warnings.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-yellow-500 p-4 rounded">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-yellow-800 dark:text-yellow-300 mb-2">
                                            ${validation.warnings.length} Aviso(s)
                                        </h3>
                                        <div class="space-y-1 max-h-32 overflow-y-auto">
                                            ${validation.warnings.slice(0, 3).map(row => `
                                                <p class="text-xs text-yellow-700 dark:text-yellow-300">
                                                    Linha ${row.rowIndex}: ${row.warnings.join(', ')}
                                                </p>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Duplicatas -->
                    ${validation.duplicates.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-orange-50 dark:bg-orange-900/10 border-l-4 border-orange-500 p-4 rounded">
                                <h3 class="font-bold text-orange-800 dark:text-orange-300 mb-2">
                                    <i class="fa-solid fa-copy mr-2"></i>
                                    ${validation.duplicates.length} Duplicata(s) Detectada(s)
                                </h3>
                                <p class="text-xs text-orange-600 dark:text-orange-300">
                                    Registros com mesma data, produto e valor
                                </p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Outliers -->
                    ${validation.outliers.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-purple-50 dark:bg-purple-900/10 border-l-4 border-purple-500 p-4 rounded">
                                <h3 class="font-bold text-purple-800 dark:text-purple-300 mb-2">
                                    <i class="fa-solid fa-chart-line mr-2"></i>
                                    ${validation.outliers.length} Outlier(s) Detectado(s)
                                </h3>
                                <p class="text-xs text-purple-600 dark:text-purple-300">
                                    Valores estatisticamente atípicos - verifique se estão corretos
                                </p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Footer -->
                    <div class="sticky bottom-0 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-700 p-6 flex gap-3 z-10">
                        <button onclick="downloadErrorReport()" class="flex-1 px-4 py-3 bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors font-medium">
                            <i class="fa-solid fa-download mr-2"></i>
                            Baixar Relatório
                        </button>
                        <button onclick="closeValidationReport()" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">
                            <i class="fa-solid fa-check mr-2"></i>
                            Continuar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(report);
        }

        function closeValidationReport() {
            const report = document.getElementById('validation-report');
            if (report) report.remove();
        }

        function downloadErrorReport() {
            if (!lastValidation) return;
            
            const validation = lastValidation;
            let csvContent = "Linha,Tipo,Mensagem,Dados Originais\n";

            // Adicionar erros
            validation.invalid.forEach(row => {
                row.errors.forEach(error => {
                    csvContent += `${row.rowIndex},ERRO,"${error}","${JSON.stringify(row.original).replace(/"/g, '""')}"\n`;
                });
            });

            // Adicionar avisos
            validation.warnings.forEach(row => {
                row.warnings.forEach(warning => {
                    csvContent += `${row.rowIndex},AVISO,"${warning}","${JSON.stringify(row.original).replace(/"/g, '""')}"\n`;
                });
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `relatorio_validacao_${luxon.DateTime.now().toISODate()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast("Relatório baixado!", "success");
        }

        // --- DATA (Loading, Processing, Filtering) ---

        // Helper para determinar o formato da data
        function getDateFormat() {
            if (fullData.length === 0) return 'dd/MM';
            
            const years = new Set(fullData.map(d => luxon.DateTime.fromISO(d.date).year));
            
            // Se houver mais de um ano, mostra o ano.
            if (years.size > 1) {
                return 'dd/MM/yyyy';
            }
            // Caso contrário, mostra apenas dia e mês.
            return 'dd/MM';
        }
        function mapColumns(headers) {
            return DatasetValidator.mapColumns(headers); // Reutiliza o mapeamento da classe
        }

        function loadSampleData() {
            const sample = [];
            const categories = ['Eletrônicos', 'Móveis', 'Serviços', 'Software', 'Acessórios'];
            const products = {
                'Eletrônicos': ['Notebook Dell', 'Monitor 24"', 'Mouse Gamer', 'Teclado Mecânico'],
                'Móveis': ['Cadeira Ergonomica', 'Mesa de Canto', 'Sofá 2L', 'Estante'],
                'Serviços': ['Instalação', 'Garantia Extra', 'Consultoria', 'Manutenção'],
                'Software': ['Windows Pro', 'Antivirus', 'Office 365', 'Adobe CC'],
                'Acessórios': ['Cabo HDMI', 'Hub USB', 'Mousepad', 'Suporte Notebook']
            };
            const methods = ['Crédito', 'PIX', 'Boleto'];
            
            // Usando Luxon para datas
            let date = luxon.DateTime.now().minus({ days: 30 });
            
            for(let i=0; i<=30; i++) {
                const dailySales = Math.floor(Math.random() * 8) + 1; 
                for(let j=0; j<dailySales; j++) {
                    const cat = categories[Math.floor(Math.random() * categories.length)];
                    const prodList = products[cat];
                    const prod = prodList[Math.floor(Math.random() * prodList.length)];
                    const priceBase = Math.random() * 500 + 50;
                    
                    sample.push({
                        date: date.toISODate(),
                        category: cat,
                        product: prod,
                        value: parseFloat((priceBase * (1 + i/50)).toFixed(2)),
                        payment: methods[Math.floor(Math.random() * methods.length)],
                        status: Math.random() > 0.1 ? 'Concluído' : (Math.random() > 0.3 ? 'Pendente' : 'Devolvido')
                    });
                }
                date = date.plus({ days: 1 });
            }
            
            // Simula a validação para dados de exemplo (todos válidos)
            const validation = {
                valid: sample,
                invalid: [],
                warnings: [],
                duplicates: [],
                outliers: [],
                summary: { total: sample.length, valid: sample.length, invalid: 0, warnings: 0, successRate: '100%' }
            };

            processData(validation.valid);
            showToast("Dados de exemplo carregados!", "success");
        }

        function handleFileUpload(input) {
            if (!input || !input.files || !input.files[0]) {
                showToast("Nenhum arquivo selecionado", "error");
                return;
            }

            const file = input.files[0];

            // Validar tipo de arquivo
            const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'text/plain'];
            const fileName = file.name.toLowerCase();

            if (!allowedTypes.includes(file.type) && !fileName.endsWith('.csv')) {
                showToast('Formato inválido! Use apenas arquivos .CSV', 'error');
                input.value = '';
                return;
            }

            // Validar tamanho do arquivo
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > userConfig.maxFileSizeMB) {
                showToast(`Arquivo muito grande! Máximo: ${userConfig.maxFileSizeMB}MB. Seu arquivo: ${fileSizeMB.toFixed(1)}MB`, "error");
                input.value = '';
                return;
            }

            // Validar tamanho mínimo (evitar arquivos vazios)
            if (file.size < 10) {
                showToast("Arquivo vazio ou corrompido", "error");
                input.value = '';
                return;
            }

            showToast("Lendo arquivo...", "info");

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                preview: 10000, // Limitar preview para evitar sobrecarga
                complete: function(results) {
                    if (!results.data || results.data.length === 0) {
                        showToast("Arquivo vazio ou inválido!", "error");
                        return;
                    }

                    // Validar número máximo de linhas
                    if (results.data.length > 50000) {
                        showToast("Arquivo muito grande! Máximo de 50.000 linhas permitido.", "error");
                        return;
                    }

                    // Validar se há headers
                    const headers = results.meta.fields || Object.keys(results.data[0] || {});
                    if (headers.length === 0) {
                        showToast("CSV sem cabeçalhos válidos!", "error");
                        return;
                    }

                    // Guardar dados para processamento após seleção de template
                    pendingCSVData = results.data;
                    csvHeaders = headers;

                    // Abrir modal de seleção de template
                    openTemplateModal();
                },
                error: function(err) {
                    console.error('Erro ao processar CSV:', err);
                    showToast(`Erro ao processar CSV: ${err.message || 'Formato inválido'}`, "error");
                }
            });

            // Limpar input para permitir reimportação do mesmo arquivo
            input.value = '';
        }

        async function processData(data) {
            fullData = data.sort((a,b) => luxon.DateTime.fromISO(a.date).toMillis() - luxon.DateTime.fromISO(b.date).toMillis());

            // Salva dados no IndexedDB
            try {
                await saveDataToDB(fullData);
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }

            filterByDate('all');
        }

        function filterByDate(days) {
            let filterText = '';
            let forecastTitle = 'Previsão de Vendas (Próximos 7 Dias)'; // Default
            
            if (days === 7) {
                filterText = '(Últimos 7 Dias)';
            } else if (days === 30) {
                filterText = '(Últimos 30 Dias)';
                forecastTitle = 'Previsão de Vendas (Próximos 30 Dias)';
            } else {
                filterText = '(Todos os Dados)';
                forecastTitle = 'Previsão de Vendas (Próximos 7 Dias)'; // Mantém 7 dias para "Todos"
            }

            document.getElementById('sales-trend-filter').innerText = filterText;
            document.getElementById('forecast-title').innerText = forecastTitle;
            const today = luxon.DateTime.now().startOf('day');
            let startDate = null;

            if (days === 'all') {
                currentData = [...fullData];
            } else {
                startDate = today.minus({ days: days - 1 });
                currentData = fullData.filter(d => luxon.DateTime.fromISO(d.date) >= startDate);
            }
            
            // Atualiza o estado dos botões de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                btn.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-slate-700');
            });
            const activeBtn = document.getElementById(`btn-${days}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                activeBtn.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-slate-700');
            }

            calculateStats();
            updateDashboardUI();
        }

        function calculateStats() {
            const totalRev = currentData.reduce((sum, item) => sum + item.value, 0);
            const counts = {};
            const payments = {};
            const statusCount = {};
            const dateMap = {};
            const productSales = {};

            const tsCategories = {}; const tsPayments = {}; const tsStatus = {};
            const uniqueDates = [...new Set(currentData.map(d => d.date))].sort();

            currentData.forEach(d => {
                counts[d.category] = (counts[d.category] || 0) + d.value;
                payments[d.payment] = (payments[d.payment] || 0) + 1;
                statusCount[d.status] = (statusCount[d.status] || 0) + 1;
                dateMap[d.date] = (dateMap[d.date] || 0) + d.value;

                if(!productSales[d.product]) productSales[d.product] = { qty: 0, total: 0 };
                productSales[d.product].qty += 1;
                productSales[d.product].total += d.value;

                if(!tsCategories[d.category]) tsCategories[d.category] = {}; tsCategories[d.category][d.date] = (tsCategories[d.category][d.date] || 0) + d.value;
                if(!tsPayments[d.payment]) tsPayments[d.payment] = {}; tsPayments[d.payment][d.date] = (tsPayments[d.payment][d.date] || 0) + d.value;
                if(!tsStatus[d.status]) tsStatus[d.status] = {}; tsStatus[d.status][d.date] = (tsStatus[d.status][d.date] || 0) + 1;
            });

            const fillZeros = (obj) => { uniqueDates.forEach(date => { if(!obj[date]) obj[date] = 0; }); return obj; };
            Object.values(tsCategories).forEach(fillZeros); Object.values(tsPayments).forEach(fillZeros); Object.values(tsStatus).forEach(fillZeros);

            const topCat = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
            const topCatValue = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[1] || 0;
            const topCatShare = totalRev > 0 ? ((topCatValue / totalRev) * 100).toFixed(1) : 0;
            const topProducts = Object.entries(productSales).map(([name, data]) => ({ name, ...data })).sort((a,b) => b.total - a.total).slice(0, 5);

            // Calcular tendências comparando com período anterior
            const trends = calculateTrends(currentData, fullData);

            stats = {
                revenue: totalRev,
                sales: currentData.length,
                avgTicket: currentData.length ? totalRev / currentData.length : 0,
                topCategory: topCat,
                topCategoryShare: topCatShare,
                catBreakdown: counts,
                payBreakdown: payments,
                statusBreakdown: statusCount,
                dailySales: dateMap,
                topProducts: topProducts,
                trends: trends
            };
            timeSeriesData = { dates: uniqueDates, categories: tsCategories, payments: tsPayments, status: tsStatus };
        }

        function calculateTrends(currentData, fullData) {
            if (currentData.length === 0 || fullData.length === 0) {
                return { revenue: 0, sales: 0, ticket: 0 };
            }

            // Determinar o período atual
            const currentDates = currentData.map(d => d.date).sort();
            const periodLength = currentDates.length > 0 ?
                (luxon.DateTime.fromISO(currentDates[currentDates.length - 1]).diff(luxon.DateTime.fromISO(currentDates[0]), 'days').days + 1) : 0;

            if (periodLength <= 0) return { revenue: 0, sales: 0, ticket: 0 };

            // Calcular data de início do período anterior
            const currentStart = luxon.DateTime.fromISO(currentDates[0]);
            const prevEnd = currentStart.minus({ days: 1 });
            const prevStart = prevEnd.minus({ days: periodLength - 1 });

            // Filtrar dados do período anterior
            const prevData = fullData.filter(d => {
                const date = luxon.DateTime.fromISO(d.date);
                return date >= prevStart && date <= prevEnd;
            });

            // Calcular métricas do período anterior
            const prevRevenue = prevData.reduce((sum, item) => sum + item.value, 0);
            const prevSales = prevData.length;
            const prevTicket = prevSales > 0 ? prevRevenue / prevSales : 0;

            // Calcular métricas do período atual
            const currRevenue = currentData.reduce((sum, item) => sum + item.value, 0);
            const currSales = currentData.length;
            const currTicket = currSales > 0 ? currRevenue / currSales : 0;

            // Calcular variação percentual
            const calcChange = (curr, prev) => {
                if (prev === 0) return curr > 0 ? 100 : 0;
                return ((curr - prev) / prev) * 100;
            };

            return {
                revenue: calcChange(currRevenue, prevRevenue),
                sales: calcChange(currSales, prevSales),
                ticket: calcChange(currTicket, prevTicket),
                hasPrevData: prevData.length > 0
            };
        }

        // --- CHARTS (Rendering, Forecasting) ---
        function updateChartsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const color = isDark ? '#e2e8f0' : '#334155';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            chartTheme = {
                color: color,
                gridColor: gridColor,
                font: { family: 'Inter', size: 12 },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                    titleColor: color,
                    bodyColor: color,
                    borderColor: isDark ? '#475569' : '#cbd5e1',
                    borderWidth: 1,
                }
            };

            // Re-render all charts with new theme
            Object.values(charts).forEach(chart => {
                chart.options.color = chartTheme.color;
                chart.options.scales.y.ticks.color = chartTheme.color;
                chart.options.scales.x.ticks.color = chartTheme.color;
                chart.options.scales.y.grid.color = chartTheme.gridColor;
                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = chartTheme.gridColor;
                chart.options.plugins.tooltip = chartTheme.tooltip;
                chart.update();
            });
        }

        function initChart(id, type, data, options) {
            const canvas = document.getElementById(id);
            if(!canvas) {
                console.warn(`Canvas #${id} não encontrado`);
                return null;
            }

            // Destroy existing chart safely
            if(charts[id]) {
                try {
                    charts[id].destroy();
                    charts[id] = null;
                } catch (error) {
                    console.error(`Erro ao destruir gráfico ${id}:`, error);
                }
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Não foi possível obter contexto 2D para ${id}`);
                return null;
            }
            
            // Merge common options with specific options
            const commonOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                layout: { padding: 10 }, 
                color: chartTheme.color,
                font: chartTheme.font,
                plugins: { 
                    legend: { 
                        labels: { 
                            usePointStyle: true, 
                            boxWidth: 8, 
                            padding: 20, 
                            font: chartTheme.font,
                            color: chartTheme.color
                        } 
                    },
                    tooltip: chartTheme.tooltip
                },
                scales: {
                    y: {
                        ticks: { color: chartTheme.color },
                        grid: { borderDash: [5, 5], color: chartTheme.gridColor }
                    },
                    x: {
                        ticks: { color: chartTheme.color },
                        grid: { display: false }
                    }
                }
            };

            charts[id] = new Chart(ctx, { 
                type, 
                data, 
                options: Chart.helpers.merge(commonOptions, options) 
            });
        }

        function renderDashboardCharts() {
            updateChartsTheme();

            const dates = Object.keys(stats.dailySales).sort();
            const values = dates.map(d => stats.dailySales[d]);
            
            const dateFormat = getDateFormat();
            initChart('lineChart', 'line', {
                labels: dates,
                datasets: [{ label: 'Vendas', data: values, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }]
            }, { 
                scales: { 
                    y: { beginAtZero: true }, 
                    x: { 
                        grid: { display: false },
                        ticks: {
                            callback: function(value, index, ticks) {
                                // Formata a data para o formato DD/MM ou DD/MM/YYYY
                                return luxon.DateTime.fromISO(this.getLabelForValue(value)).toFormat(dateFormat);
                            }
                        }
                    } 
                } 
            });

            initChart('paymentChart', 'bar', {
                labels: Object.keys(stats.payBreakdown),
                datasets: [{ label: 'Qtd', data: Object.values(stats.payBreakdown), backgroundColor: ['#3b82f6', '#14b8a6', '#f43f5e'], borderRadius: 4 }]
            }, { 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { grid: { display: false } }, 
                    y: { beginAtZero: true } 
                } 
            });

            initChart('barChart', 'bar', {
                labels: Object.keys(stats.catBreakdown),
                datasets: [{ label: 'R$', data: Object.values(stats.catBreakdown), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6'], borderRadius: 4 }]
            }, { 
                indexAxis: 'y', 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { grid: { borderDash: [5, 5], color: chartTheme.gridColor } }, 
                    y: { grid: { display: false } } 
                } 
            });

            initChart('doughnutChart', 'doughnut', {
                labels: Object.keys(stats.statusBreakdown),
                datasets: [{ 
                    label: 'Pedidos', 
                    data: Object.values(stats.statusBreakdown), 
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], // Verde, Amarelo, Vermelho
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            }, { 
                cutout: '70%', 
                plugins: { legend: { position: 'right', labels: { usePointStyle: true } } } 
            });
        }

        function getFutureDates(last, days) {
            const d = luxon.DateTime.fromISO(last);
            const res = [];
            for(let i=1; i<=days; i++) {
                res.push(d.plus({ days: i }).toISODate());
            }
            return res;
        }

        // Mantém a função antiga para compatibilidade mas usa a nova internamente
        function calculateForecast(dates, values) {
            return calculateAdvancedForecast(dates, values, userConfig.forecastDays);
        }

        function createForecastDataset(label, hist, future, color) {
            const days = userConfig.forecastDays;
            const padNull = Array(days).fill(null);
            const padHist = Array(hist.length).fill(null);
            padHist[hist.length-1] = hist[hist.length-1];
            return [{
                label: label,
                data: [...hist, ...padNull],
                borderColor: color,
                backgroundColor: color,
                tension: 0.3,
                pointRadius: 2,
                segment: {
                    borderColor: ctx => ctx.p0.parsed.y === null ? 'transparent' : color,
                }
            },
            {
                label: label + ' (Prev)',
                data: [...padHist, ...future],
                borderColor: color,
                borderDash: [5,5],
                pointStyle: 'rectRot',
                backgroundColor: 'transparent',
                pointRadius: 4,
                pointHoverRadius: 6
            }];
        }

        function updateForecastView(type) {
            // Atualiza título
            document.getElementById('forecast-title').innerText = `Previsão de Vendas (Próximos ${userConfig.forecastDays} Dias)`;

            document.querySelectorAll('.forecast-btn').forEach(btn => {
                if(btn.dataset.type === type) {
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                } else {
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                }
            });

            const dates = timeSeriesData.dates || [];
            if(!dates.length) return;
            const datasets = [];
            const days = userConfig.forecastDays;

            if (type === 'general') {
                const values = dates.map(d => stats.dailySales[d] || 0);
                const forecast = calculateAdvancedForecast(dates, values, days);
                datasets.push(createForecastDataset('Geral', values, forecast, '#6366f1'));
            } else {
                let sourceData = type === 'categories' ? timeSeriesData.categories : (type === 'payments' ? timeSeriesData.payments : timeSeriesData.status);
                const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
                Object.keys(sourceData).slice(0,4).forEach((key, i) => {
                    const values = dates.map(d => sourceData[key][d] || 0);
                    const forecast = calculateAdvancedForecast(dates, values, days);
                    datasets.push(createForecastDataset(key, values, forecast, colors[i]));
                });
            }

            const forecastDateFormat = getDateFormat();
            initChart('forecastChart', 'line', {
                labels: [...dates, ...getFutureDates(dates[dates.length-1], days)],
                datasets: datasets.flat()
            }, {
                scales: {
                    y: { beginAtZero: true },
                    x: {
                        grid: { display: false },
                        ticks: {
                            callback: function(value, index, ticks) {
                                return luxon.DateTime.fromISO(this.getLabelForValue(value)).toFormat(forecastDateFormat);
                            }
                        }
                    }
                }
            });
        }

        // --- AI (Chat, Analysis) ---
        function toggleChatPanel() {
            document.getElementById('ai-chat-panel').classList.toggle('translate-x-full');
        }

        function renderChatHistory() {
            const historyEl = document.getElementById('chat-history');
            if (!historyEl) return;

            historyEl.innerHTML = '<div class="chat-bubble chat-ai">Olá! Sou o seu assistente de BI. Carregue seus dados e me pergunte sobre tendências, anomalias ou previsões.</div>';

            chatHistory.forEach(msg => {
                if (!msg || !msg.role || !msg.content) return;

                if (msg.role === 'user') {
                    // Sanitize user content
                    const sanitizedContent = String(msg.content).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    historyEl.innerHTML += `<div class="chat-bubble chat-user">${sanitizedContent}</div>`;
                } else {
                    // AI responses are already processed by marked
                    try {
                        historyEl.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(msg.content)}</div>`;
                    } catch (error) {
                        console.error('Erro ao renderizar markdown:', error);
                        const sanitizedContent = String(msg.content).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        historyEl.innerHTML += `<div class="chat-bubble chat-ai">${sanitizedContent}</div>`;
                    }
                }
            });
            historyEl.scrollTop = historyEl.scrollHeight;
        }

        function clearChatHistory() {
            chatHistory = [];
            saveChatHistory();
            renderChatHistory();
            showToast('Histórico do chat limpo!', 'info');
        }

        async function analyzeSpecificChart(type) {
            if(!stats.sales) return showToast("Carregue dados primeiro", "info");

            document.getElementById('ai-chat-panel').classList.remove('translate-x-full');
            const questions = {
                'sales_trend': 'Analise a tendência de vendas diárias.',
                'payment_methods': 'Analise a distribuição de pagamentos.',
                'category_performance': 'Analise o desempenho das categorias.',
                'order_status': 'Analise o status dos pedidos.'
            };
            document.getElementById('chat-input').value = questions[type];
            await sendChatMessage(stats);
        }

        async function sendChatMessage(ctx = null) {
            const input = document.getElementById('chat-input');
            const historyEl = document.getElementById('chat-history');

            if (!input || !historyEl) {
                showToast("Erro ao acessar elementos do chat", "error");
                return;
            }

            const text = input.value.trim();

            if(!text && !ctx) return;
            if(apiKey === 'SUA_CHAVE_AQUI') return showToast("Configure sua API Key primeiro!", "error");

            // Sanitize user input to prevent XSS
            const sanitizedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Adiciona mensagem do usuário ao histórico
            chatHistory.push({ role: 'user', content: text, timestamp: Date.now() });
            historyEl.innerHTML += `<div class="chat-bubble chat-user">${sanitizedText}</div>`;
            input.value = '';
            historyEl.scrollTop = historyEl.scrollHeight;

            const loadingId = 'load'+Date.now();
            historyEl.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-ai italic"><i class="fa-solid fa-circle-notch fa-spin"></i> ...</div>`;
            historyEl.scrollTop = historyEl.scrollHeight;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(apiKey)}`,  {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Você é um Analista de ERP. Seu objetivo é fornecer insights rápidos e práticos para um empresário. O contexto dos dados é: ${JSON.stringify(ctx || stats)}. A pergunta do usuário é: "${text}". Responda de forma concisa em português do Brasil, usando Markdown.`
                            }]
                        }]
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if(!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }

                // Validação da resposta da API
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                    throw new Error("Resposta da API inválida");
                }

                // Usando marked para renderizar o Markdown da resposta da IA
                const aiResponse = data.candidates[0].content.parts[0].text;

                // Adiciona resposta da IA ao histórico
                chatHistory.push({ role: 'assistant', content: aiResponse, timestamp: Date.now() });
                await saveChatHistory();

                historyEl.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(aiResponse)}</div>`;
                historyEl.scrollTop = historyEl.scrollHeight;
            } catch(e) {
                console.error('Erro na API do Gemini:', e);
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.innerText = "Erro: Verifique sua Chave API ou a conexão.";
                }

                if (e.name === 'AbortError') {
                    showToast("Tempo limite excedido. Tente novamente.", "error");
                } else {
                    showToast("Erro na comunicação com a API do Gemini.", "error");
                }
            }
        }

        // --- UI (View Switching, Dashboard Update) ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-nav', 'bg-indigo-600', 'text-white', 'dark:bg-indigo-700', 'dark:text-white');
                item.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-indigo-50', 'dark:hover:bg-indigo-900/20', 'hover:text-indigo-600', 'dark:hover:text-indigo-400');
            });

            const activeNav = document.getElementById(`nav-${view}`);
            if (activeNav) {
                activeNav.classList.add('active-nav', 'bg-indigo-600', 'text-white', 'dark:bg-indigo-700', 'dark:text-white');
                activeNav.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-indigo-50', 'dark:hover:bg-indigo-900/20', 'hover:text-indigo-600', 'dark:hover:text-indigo-400');
            }

            const title = view === 'dashboard' ? 'Visão Geral' : 'Previsões Futuras';
            document.getElementById('page-title').innerText = title;

            // Atualiza o conteúdo da view
            if (view === 'dashboard') {
                updateDashboardUI();
            } else if (view === 'forecast') {
                updateForecastView('general');
            }
        }

        function updateDashboardUI() {
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            // Helper para criar indicador de tendência
            const trendIndicator = (value, hasPrevData) => {
                if (!hasPrevData) return `<span class="text-gray-400">${currentData.length} registros</span>`;

                const absValue = Math.abs(value).toFixed(1);
                if (value > 0) {
                    return `<i class="fa-solid fa-arrow-up text-green-500"></i> <span class="text-green-600 dark:text-green-400">+${absValue}%</span> <span class="text-gray-400 text-[10px]">vs período anterior</span>`;
                } else if (value < 0) {
                    return `<i class="fa-solid fa-arrow-down text-red-500"></i> <span class="text-red-600 dark:text-red-400">${absValue}%</span> <span class="text-gray-400 text-[10px]">vs período anterior</span>`;
                } else {
                    return `<i class="fa-solid fa-minus text-gray-400"></i> <span class="text-gray-500">0%</span> <span class="text-gray-400 text-[10px]">vs período anterior</span>`;
                }
            };

            // Update KPIs
            document.getElementById('kpi-revenue').innerText = fmt.format(stats.revenue);
            document.getElementById('kpi-sales').innerText = stats.sales;
            document.getElementById('kpi-ticket').innerText = fmt.format(stats.avgTicket);
            document.getElementById('kpi-category').innerText = stats.topCategory;

            // Update trends
            const trends = stats.trends || { revenue: 0, sales: 0, ticket: 0, hasPrevData: false };
            document.getElementById('kpi-revenue-trend').innerHTML = trendIndicator(trends.revenue, trends.hasPrevData);
            document.getElementById('kpi-sales-trend').innerHTML = trendIndicator(trends.sales, trends.hasPrevData);
            document.getElementById('kpi-ticket-trend').innerHTML = trendIndicator(trends.ticket, trends.hasPrevData);
            document.getElementById('kpi-category-share').innerText = stats.topCategoryShare ? `${stats.topCategoryShare}% da receita` : 'Em volume de vendas';

            // Update Recent Transactions Table
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            currentData.slice(-5).reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium">${row.date}</td><td class="p-4 text-gray-500 dark:text-gray-400">${row.product}</td><td class="p-4 text-right font-bold text-gray-700 dark:text-gray-200">${fmt.format(row.value)}</td>`;
                tbody.appendChild(tr);
            });
            
            // Update Top Products Table
            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';
            stats.topProducts.forEach(prod => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium text-gray-700 dark:text-gray-200">${prod.name}</td><td class="p-4 text-right text-xs text-gray-500 dark:text-gray-400">${prod.qty} un</td><td class="p-4 text-right font-bold text-indigo-600 dark:text-indigo-400">${fmt.format(prod.total)}</td>`;
                topBody.appendChild(tr);
            });

            renderDashboardCharts();
            if (currentView === 'forecast') {
                updateForecastView('general');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();

            try {
                // Inicializa o banco de dados
                await openDatabase();

                // Carrega configurações do usuário
                await loadConfig();

                // Carrega template salvo
                const savedTemplate = localStorage.getItem('nexus_template');
                if (savedTemplate && dataTemplates[savedTemplate]) {
                    currentTemplate = savedTemplate;
                    updateDashboardLabels();
                }

                // Carrega histórico do chat
                const savedChat = await loadChatHistory();
                if (savedChat && savedChat.length > 0) {
                    chatHistory = savedChat;
                    renderChatHistory();
                }

                // Carrega dados salvos
                const savedData = await loadDataFromDB();
                if (savedData && savedData.length > 0) {
                    // Remove propriedades do IndexedDB
                    fullData = savedData.map(({id, ...rest}) => rest);
                    filterByDate('all');
                    showToast(`${fullData.length} registros restaurados!`, 'success');
                } else {
                    // Se não há dados salvos, carrega dados de exemplo
                    loadSampleData();
                }
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                // Fallback: carrega dados de exemplo
                loadSampleData();
            }

            // Listener para o input do chat
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if(e.key==='Enter') sendChatMessage();
            });

            // Atalhos de teclado
            document.addEventListener('keydown', handleKeyboardShortcuts);
        });

        // --- KEYBOARD SHORTCUTS ---
        function handleKeyboardShortcuts(e) {
            // Ignorar se estiver digitando em um input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                // Escape fecha modais mesmo em inputs
                if (e.key === 'Escape') {
                    closeAllModals();
                }
                return;
            }

            // Atalhos com Ctrl/Cmd
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'e': // Ctrl+E - Exportar
                        e.preventDefault();
                        openExportModal();
                        break;
                    case 'f': // Ctrl+F - Filtros
                        e.preventDefault();
                        openFiltersModal();
                        break;
                    case 's': // Ctrl+S - Configurações
                        e.preventDefault();
                        openSettingsModal();
                        break;
                    case 'i': // Ctrl+I - Importar CSV
                        e.preventDefault();
                        document.getElementById('csv-file-input').click();
                        break;
                }
                return;
            }

            // Atalhos simples (sem modificadores)
            switch(e.key) {
                case 'Escape':
                    closeAllModals();
                    break;
                case '1':
                    switchView('dashboard');
                    break;
                case '2':
                    switchView('forecast');
                    break;
                case '3':
                    toggleChatPanel();
                    break;
                case 'd':
                case 'D':
                    toggleTheme();
                    break;
                case '7':
                    filterByDate(7);
                    break;
                case '0':
                    filterByDate(30);
                    break;
                case 'a':
                case 'A':
                    filterByDate('all');
                    break;
                case '?':
                    showKeyboardShortcuts();
                    break;
            }
        }

        function closeAllModals() {
            document.getElementById('api-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('export-modal').classList.add('hidden');
            document.getElementById('filters-modal').classList.add('hidden');
            document.getElementById('template-modal').classList.add('hidden');
            document.getElementById('mapping-modal').classList.add('hidden');

            // Remover modais dinâmicos
            const validationReport = document.getElementById('validation-report');
            if (validationReport) validationReport.remove();

            const quickTemplateModal = document.getElementById('quick-template-modal');
            if (quickTemplateModal) quickTemplateModal.remove();

            const shortcutsModal = document.getElementById('shortcuts-modal');
            if (shortcutsModal) shortcutsModal.remove();

            // Fecha o chat se estiver aberto
            const chatPanel = document.getElementById('ai-chat-panel');
            if (!chatPanel.classList.contains('translate-x-full')) {
                chatPanel.classList.add('translate-x-full');
            }
        }

        function showKeyboardShortcuts() {
            const shortcuts = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm" id="shortcuts-modal" onclick="this.remove()">
                    <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-[400px] max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Atalhos de Teclado</h3>
                            <button onclick="document.getElementById('shortcuts-modal').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fa-solid fa-xmark text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 mb-2">Navegação</h4>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>Dashboard</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">1</kbd></div>
                                    <div class="flex justify-between"><span>Previsões</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">2</kbd></div>
                                    <div class="flex justify-between"><span>Chat IA</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">3</kbd></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 mb-2">Filtros</h4>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>Últimos 7 dias</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">7</kbd></div>
                                    <div class="flex justify-between"><span>Últimos 30 dias</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">0</kbd></div>
                                    <div class="flex justify-between"><span>Todos os dados</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">A</kbd></div>
                                    <div class="flex justify-between"><span>Filtros avançados</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">Ctrl+F</kbd></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 mb-2">Ações</h4>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>Exportar</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">Ctrl+E</kbd></div>
                                    <div class="flex justify-between"><span>Importar CSV</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">Ctrl+I</kbd></div>
                                    <div class="flex justify-between"><span>Configurações</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">Ctrl+S</kbd></div>
                                    <div class="flex justify-between"><span>Alternar tema</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">D</kbd></div>
                                    <div class="flex justify-between"><span>Fechar modais</span><kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-800 rounded">Esc</kbd></div>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-4 text-center">Pressione <kbd class="px-1 bg-gray-100 dark:bg-slate-800 rounded">?</kbd> para ver este menu</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', shortcuts);
        }
    </script>
</body>
</html>
