<!DOCTYPE html>
<html lang="pt-BR" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ERP Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const initTailwind = () => {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    darkMode: 'class',
                    theme: {
                        extend: {
                            colors: {
                                slate: { 850: '#1e293b', 950: '#020617' }
                            }
                        }
                    }
                };
            } else {
                setTimeout(initTailwind, 50);
            }
        };
        initTailwind();
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .trans-all { transition: all 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* Chat Styles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        .chat-user { background-color: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f1f5f9; border: 1px solid #e2e8f0; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        .dark .chat-ai { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }
        .dark .chat-ai strong { color: #818cf8; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 8px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(120%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; border-left: 4px solid; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }
        .toast-info { border-color: #3b82f6; }
        .dark .toast { background: #1e293b; color: white; }

        /* Animation */
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .btn-shine { background: linear-gradient(to right, #4f46e5 20%, #818cf8 40%, #818cf8 60%, #4f46e5 80%); background-size: 200% auto; animation: shine 4s linear infinite; }

        /* Print CSS - O Mágico do PDF */
        @media print {
            aside, header, #ai-chat-panel, .no-print { display: none !important; }
            body, main { overflow: visible !important; height: auto !important; background: white !important; color: black !important; }
            .card, .bg-white { box-shadow: none !important; border: 1px solid #ddd !important; break-inside: avoid; }
            #view-dashboard { display: block !important; padding: 0 !important; }
            /* Ajuste para caber gráficos na folha */
            canvas { max-height: 250px !important; } 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-950 dark:text-gray-100 trans-all overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- API Key Modal -->
    <div id="api-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-96 transform scale-95 transition-transform" id="api-modal-content">
            <h3 class="text-xl font-bold mb-2">Configurar IA</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Insira sua chave do Google Gemini para ativar o consultor inteligente.</p>
            <input type="password" id="api-key-input" placeholder="Cole sua chave AIza..." class="w-full p-3 border border-gray-300 dark:border-slate-700 rounded-lg mb-4 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeApiModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salvar</button>
            </div>
            <p class="text-xs text-center mt-4 text-gray-400">A chave fica salva apenas no seu navegador.</p>
        </div>
    </div>

    <div class="flex h-screen">
        
        <!-- SIDEBAR -->
        <aside class="w-20 md:w-64 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col flex-shrink-0 z-20 trans-all shadow-lg print:hidden">
            <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-gray-100 dark:border-slate-800">
                <div class="flex items-center gap-3 text-indigo-600 dark:text-indigo-400 font-bold text-xl">
                    <i class="fa-solid fa-layer-group text-2xl"></i>
                    <span class="hidden md:block">Nexus ERP</span>
                </div>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-xl trans-all group active-nav">
                    <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Visão Geral</span>
                </button>
                
                <button onclick="switchView('forecast')" id="nav-forecast" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600 dark:hover:text-purple-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-crystal-ball text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Previsões Futuras</span>
                </button>

                <button onclick="toggleChatPanel()" class="w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-robot text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Consultor IA</span>
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100 dark:border-slate-800">
                <div class="bg-indigo-50 dark:bg-slate-800 p-4 rounded-xl hidden md:block">
                    <p class="text-xs font-semibold text-indigo-900 dark:text-indigo-200 mb-1">Status do Sistema</p>
                    <div class="flex items-center gap-2 text-green-600 dark:text-green-400 text-xs font-bold">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        Online
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 relative">
            
            <!-- TOP BAR -->
            <header class="h-auto md:h-16 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 flex flex-col md:flex-row items-center justify-between px-6 py-2 md:py-0 trans-all z-10 gap-2 print:hidden">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-gray-700 dark:text-gray-100 hidden md:block">Visão Geral</h2>
                    
                    <!-- FILTROS DE DATA -->
                    <div class="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-1">
                        <button onclick="filterByDate(7)" id="btn-7d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700 shadow-sm">7 Dias</button>
                        <button onclick="filterByDate(30)" id="btn-30d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700">30 Dias</button>
                        <button onclick="filterByDate('all')" id="btn-all" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm">Todos</button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Config API -->
                    <button onclick="openApiModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-800 trans-all" title="Configurar API Key">
                        <i class="fa-solid fa-gear"></i>
                    </button>

                    <!-- Theme -->
                    <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-yellow-400 hover:ring-2 ring-indigo-500 trans-all">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </button>
                    
                    <!-- Print -->
                    <button onclick="window.print()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 trans-all" title="Imprimir Relatório">
                        <i class="fa-solid fa-print"></i>
                    </button>

                    <!-- Export -->
                    <button onclick="exportData()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 trans-all" title="Baixar CSV">
                        <i class="fa-solid fa-download"></i>
                    </button>

                    <div class="h-6 w-[1px] bg-gray-300 dark:bg-slate-700 mx-1"></div>

                    <button onclick="loadSampleData()" class="px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 rounded-lg font-medium text-xs hover:bg-indigo-100 dark:hover:bg-indigo-900/50 trans-all">
                        Exemplo
                    </button>
                    
                    <label class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium text-xs cursor-pointer shadow-lg shadow-indigo-500/30 trans-all hover:-translate-y-0.5">
                        <i class="fa-solid fa-upload mr-1"></i> CSV
                        <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                </div>
            </header>

            <!-- VIEWS CONTAINER -->
            <div class="flex-1 overflow-y-auto p-6 relative">
                
                <!-- VIEW 1: DASHBOARD GERAL -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in pb-20">
                    <!-- KPIs Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl p-6 text-white shadow-lg shadow-indigo-500/20 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 trans-all">
                                <i class="fa-solid fa-sack-dollar text-9xl"></i>
                            </div>
                            <p class="text-indigo-100 font-medium text-sm">Receita Total</p>
                            <h3 class="text-3xl font-bold mt-1" id="kpi-revenue">R$ 0,00</h3>
                            <p class="text-xs text-indigo-200 mt-2 bg-white/20 inline-block px-2 py-1 rounded" id="kpi-growth">--</p>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 trans-all">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Vendas Totais</p>
                                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mt-1" id="kpi-sales">0</h3>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg text-green-600 dark:text-green-400">
                                    <i class="fa-solid fa-cart-shopping"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 trans-all">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Ticket Médio</p>
                                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mt-1" id="kpi-ticket">R$ 0,00</h3>
                                </div>
                                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-lg text-purple-600 dark:text-purple-400">
                                    <i class="fa-solid fa-receipt"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 trans-all">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Top Categoria</p>
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mt-1 truncate" id="kpi-category">-</h3>
                                </div>
                                <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-lg text-orange-600 dark:text-orange-400">
                                    <i class="fa-solid fa-trophy"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col">
                            <div class="flex justify-between items-center mb-4 no-print">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-arrow-trend-up text-indigo-500"></i> Fluxo de Vendas
                                </h3>
                                <button onclick="analyzeSpecificChart('sales_trend')" class="text-xs flex items-center gap-1 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-full transition-colors border border-indigo-100 dark:border-indigo-800/50">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> Insight
                                </button>
                            </div>
                            <div class="relative w-full h-80 flex-1">
                                <canvas id="lineChart" class="w-full h-full"></canvas>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col relative group">
                            <div class="flex justify-between items-center mb-4 no-print">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Pagamentos</h3>
                                <button onclick="analyzeSpecificChart('payment_methods')" class="text-xs flex items-center gap-1 bg-purple-50 hover:bg-purple-100 dark:bg-purple-900/30 dark:hover:bg-purple-900/50 text-purple-600 dark:text-purple-300 px-3 py-1.5 rounded-full transition-colors border border-purple-100 dark:border-purple-800/50 shadow-sm btn-shine text-white font-medium border-0">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> Analisar
                                </button>
                            </div>
                            <div class="relative w-full h-80 flex justify-center items-center flex-1">
                                <canvas id="paymentChart" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col">
                            <div class="flex justify-between items-center mb-4 no-print">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Por Categoria</h3>
                                <button onclick="analyzeSpecificChart('category_performance')" class="text-xs flex items-center gap-1 bg-gray-50 hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-full transition-colors">
                                    <i class="fa-solid fa-magnifying-glass-chart"></i> Detalhes
                                </button>
                            </div>
                            <div class="relative w-full h-80 flex-1">
                                <canvas id="barChart" class="w-full h-full"></canvas>
                            </div>
                        </div>

                         <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col">
                            <div class="flex justify-between items-center mb-4 no-print">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Status Pedidos</h3>
                                <button onclick="analyzeSpecificChart('order_status')" class="text-xs flex items-center gap-1 bg-gray-50 hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-full transition-colors">
                                    <i class="fa-solid fa-magnifying-glass-chart"></i> Detalhes
                                </button>
                            </div>
                            <div class="relative w-full h-80 flex justify-center items-center flex-1">
                                <canvas id="doughnutChart" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Products -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden">
                            <div class="p-5 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-crown text-yellow-500"></i> Top Produtos
                                </h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-50 dark:bg-slate-700/50 text-gray-500 dark:text-gray-400 uppercase text-xs">
                                        <tr>
                                            <th class="p-4">Produto</th>
                                            <th class="p-4 text-right">Qtd</th>
                                            <th class="p-4 text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topProductsBody" class="divide-y divide-gray-100 dark:divide-slate-700 text-gray-600 dark:text-gray-300"></tbody>
                                </table>
                            </div>
                        </div>

                         <!-- Recent Transactions -->
                         <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden">
                            <div class="p-5 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800 dark:text-gray-100">Transações Recentes</h3>
                                <span class="text-xs text-gray-400">Últimas 5</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-50 dark:bg-slate-700/50 text-gray-500 dark:text-gray-400 uppercase text-xs">
                                        <tr>
                                            <th class="p-4">Data</th>
                                            <th class="p-4">Produto</th>
                                            <th class="p-4 text-right">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody" class="divide-y divide-gray-100 dark:divide-slate-700 text-gray-600 dark:text-gray-300">
                                        <tr><td colspan="3" class="p-8 text-center text-gray-400 italic">Nenhum dado carregado.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: FORECAST -->
                <div id="view-forecast" class="space-y-6 hidden animate-fade-in pb-20">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-8 text-white shadow-lg">
                        <h2 class="text-3xl font-bold mb-2">Inteligência Preditiva</h2>
                        <p class="text-indigo-100 max-w-2xl">
                            Utilizamos algoritmos de regressão linear para analisar tendências e projetar os próximos 7 dias.
                        </p>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                                <i class="fa-solid fa-chart-line text-purple-500"></i>
                                <span id="forecast-title">Projeção Geral (Receita)</span>
                            </h3>
                            <div class="flex bg-gray-100 dark:bg-slate-900 rounded-lg p-1 gap-1 overflow-x-auto max-w-full no-print">
                                <button onclick="updateForecastView('general')" class="forecast-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-300 shadow-sm" data-type="general">Geral</button>
                                <button onclick="updateForecastView('categories')" class="forecast-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-gray-500 dark:text-gray-400 hover:text-purple-600" data-type="categories">Categorias</button>
                                <button onclick="updateForecastView('payments')" class="forecast-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-gray-500 dark:text-gray-400 hover:text-purple-600" data-type="payments">Pagamentos</button>
                                <button onclick="updateForecastView('status')" class="forecast-btn px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-gray-500 dark:text-gray-400 hover:text-purple-600" data-type="status">Status</button>
                            </div>
                        </div>
                        <div class="relative w-full h-96">
                            <canvas id="forecastChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT PANEL -->
            <div id="ai-chat-panel" class="absolute right-0 top-0 bottom-0 w-96 bg-white dark:bg-slate-900 border-l border-gray-200 dark:border-slate-800 shadow-2xl z-30 transform translate-x-full trans-all flex flex-col no-print">
                <div class="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-robot"></i><h3 class="font-bold">Consultor IA</h3></div>
                    <button onclick="toggleChatPanel()" class="hover:bg-indigo-700 p-1 rounded trans-all"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="chat-history" class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-slate-950 flex flex-col space-y-3">
                    <div class="chat-bubble chat-ai">Olá! Sou seu assistente executivo. Analiso seus dados em tempo real.</div>
                </div>
                <div class="p-4 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800">
                    <div class="relative">
                        <textarea id="chat-input" rows="2" placeholder="Ex: Analise a tendência..." class="w-full p-3 pr-10 bg-gray-100 dark:bg-slate-800 text-gray-800 dark:text-gray-200 border border-transparent focus:bg-white dark:focus:bg-slate-950 border-gray-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none trans-all"></textarea>
                        <button onclick="sendChatMessage()" class="absolute right-2 bottom-2 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 p-1 trans-all"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- API Config & Toast System ---
        let apiKey = localStorage.getItem('nexus_api_key') || "";
        
        function openApiModal() { document.getElementById('api-modal').classList.remove('hidden'); document.getElementById('api-key-input').value = apiKey; }
        function closeApiModal() { document.getElementById('api-modal').classList.add('hidden'); }
        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if(val) {
                apiKey = val;
                localStorage.setItem('nexus_api_key', apiKey);
                showToast("Chave API salva com sucesso!", "success");
                closeApiModal();
            }
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'triangle-exclamation' : 'info-circle');
            let color = type === 'success' ? 'text-green-500' : (type === 'error' ? 'text-red-500' : 'text-blue-500');
            toast.innerHTML = `<i class="fa-solid fa-${icon} ${color} text-xl"></i><span class="font-medium">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- Global State ---
        let fullData = []; 
        let currentData = [];
        let charts = {}; 
        let stats = {};
        let timeSeriesData = {};
        
        // --- Filters Logic ---
        function filterByDate(days) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                btn.classList.add('text-gray-600', 'dark:text-gray-300');
            });
            const activeBtn = days === 'all' ? 'btn-all' : `btn-${days}d`;
            document.getElementById(activeBtn).classList.add('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
            document.getElementById(activeBtn).classList.remove('text-gray-600', 'dark:text-gray-300');

            if (days === 'all') {
                currentData = [...fullData];
            } else {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                currentData = fullData.filter(d => new Date(d.date) >= cutoff);
            }
            calculateStats();
            updateUI();
        }

        function exportData() {
            if (!currentData.length) return showToast("Sem dados para exportar", "error");
            const csv = Papa.unparse(currentData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "relatorio_vendas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Download iniciado!", "success");
        }

        // --- Theme Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fa-solid fa-moon';
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                icon.className = 'fa-solid fa-sun';
                localStorage.theme = 'dark';
            }
            updateChartsTheme();
        }
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
        }
        function updateChartsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#cbd5e1' : '#475569';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            Object.values(charts).forEach(chart => { if(chart) chart.update(); });
        }

        // --- View Switching ---
        function switchView(viewName) {
            ['dashboard', 'forecast'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20', 'text-indigo-600', 'dark:text-indigo-400');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('bg-indigo-50', 'dark:bg-indigo-900/20', 'text-indigo-600', 'dark:text-indigo-400');
            setTimeout(() => Object.values(charts).forEach(c => c?.resize()), 50);
        }

        // --- Helper Function: Map Columns Intelligently ---
        function mapColumns(headers) {
            const map = {
                date: headers.find(h => /data|date|dt_venda|criado_em|time/i.test(h)) || null,
                category: headers.find(h => /categoria|category|cat|setor|grupo/i.test(h)) || null,
                product: headers.find(h => /produto|product|item|mercadoria|nome|descrição|cliente|customer/i.test(h)) || null,
                value: headers.find(h => /valor|value|total|price|preço|amount|venda|custo/i.test(h)) || null,
                payment: headers.find(h => /pagamento|payment|pgto|forma|metodo/i.test(h)) || null,
                status: headers.find(h => /status|estado|situacao|situação/i.test(h)) || null
            };
            return map;
        }

        // --- Data Loading ---
        function loadSampleData() {
            const sample = [];
            const categories = ['Eletrônicos', 'Móveis', 'Serviços', 'Software', 'Acessórios'];
            const products = {
                'Eletrônicos': ['Notebook Dell', 'Monitor 24"', 'Mouse Gamer', 'Teclado Mecânico'],
                'Móveis': ['Cadeira Ergonomica', 'Mesa de Canto', 'Sofá 2L', 'Estante'],
                'Serviços': ['Instalação', 'Garantia Extra', 'Consultoria', 'Manutenção'],
                'Software': ['Windows Pro', 'Antivirus', 'Office 365', 'Adobe CC'],
                'Acessórios': ['Cabo HDMI', 'Hub USB', 'Mousepad', 'Suporte Notebook']
            };
            const methods = ['Crédito', 'PIX', 'Boleto'];
            
            let date = new Date();
            date.setDate(date.getDate() - 30); 
            
            for(let i=0; i<=30; i++) {
                const dailySales = Math.floor(Math.random() * 8) + 1; 
                for(let j=0; j<dailySales; j++) {
                    const cat = categories[Math.floor(Math.random() * categories.length)];
                    const prodList = products[cat];
                    const prod = prodList[Math.floor(Math.random() * prodList.length)];
                    const priceBase = Math.random() * 500 + 50;
                    
                    sample.push({
                        date: date.toISOString().split('T')[0],
                        category: cat,
                        product: prod,
                        value: parseFloat((priceBase * (1 + i/50)).toFixed(2)),
                        payment: methods[Math.floor(Math.random() * methods.length)],
                        status: Math.random() > 0.1 ? 'Concluído' : (Math.random() > 0.3 ? 'Pendente' : 'Devolvido')
                    });
                }
                date.setDate(date.getDate() + 1);
            }
            processData(sample);
            showToast("Dados de exemplo carregados!", "success");
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: function(results) {
                    // 1. Identify columns
                    const headers = results.meta.fields || [];
                    const map = mapColumns(headers);
                    
                    // 2. Map data
                    const norm = results.data.map(d => ({
                        date: map.date ? d[map.date] : (d.data || d.date || d.Data),
                        category: map.category ? d[map.category] : (d.categoria || d.category || 'Geral'),
                        product: map.product ? d[map.product] : (d.produto || d.product || 'Item'),
                        value: map.value ? parseFloat(d[map.value]) : parseFloat(d.valor || d.value || 0),
                        payment: map.payment ? d[map.payment] : (d.pagamento || d.payment || 'Outros'),
                        status: map.status ? d[map.status] : (d.status || 'Concluído')
                    })).filter(d => d.value > 0);

                    if(norm.length) {
                        processData(norm);
                        showToast(`${norm.length} registros importados!`, "success");
                    } else showToast("CSV inválido ou vazio.", "error");
                }
            });
        }

        function processData(data) {
            fullData = data.sort((a,b) => new Date(a.date) - new Date(b.date));
            filterByDate('all');
        }

        function calculateStats() {
            const totalRev = currentData.reduce((sum, item) => sum + item.value, 0);
            const counts = {};
            const payments = {};
            const statusCount = {};
            const dateMap = {};
            const productSales = {}; 
            
            const tsCategories = {}; const tsPayments = {}; const tsStatus = {};
            const uniqueDates = [...new Set(currentData.map(d => d.date))].sort();

            currentData.forEach(d => {
                counts[d.category] = (counts[d.category] || 0) + d.value;
                payments[d.payment] = (payments[d.payment] || 0) + 1;
                statusCount[d.status] = (statusCount[d.status] || 0) + 1;
                dateMap[d.date] = (dateMap[d.date] || 0) + d.value;
                
                if(!productSales[d.product]) productSales[d.product] = { qty: 0, total: 0 };
                productSales[d.product].qty += 1;
                productSales[d.product].total += d.value;

                if(!tsCategories[d.category]) tsCategories[d.category] = {}; tsCategories[d.category][d.date] = (tsCategories[d.category][d.date] || 0) + d.value;
                if(!tsPayments[d.payment]) tsPayments[d.payment] = {}; tsPayments[d.payment][d.date] = (tsPayments[d.payment][d.date] || 0) + d.value;
                if(!tsStatus[d.status]) tsStatus[d.status] = {}; tsStatus[d.status][d.date] = (tsStatus[d.status][d.date] || 0) + 1;
            });

            const fillZeros = (obj) => { uniqueDates.forEach(date => { if(!obj[date]) obj[date] = 0; }); return obj; };
            Object.values(tsCategories).forEach(fillZeros); Object.values(tsPayments).forEach(fillZeros); Object.values(tsStatus).forEach(fillZeros);

            const topCat = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
            const topProducts = Object.entries(productSales).map(([name, data]) => ({ name, ...data })).sort((a,b) => b.total - a.total).slice(0, 5);

            stats = {
                revenue: totalRev,
                sales: currentData.length,
                avgTicket: currentData.length ? totalRev / currentData.length : 0,
                topCategory: topCat,
                catBreakdown: counts,
                payBreakdown: payments,
                statusBreakdown: statusCount,
                dailySales: dateMap,
                topProducts: topProducts
            };
            timeSeriesData = { dates: uniqueDates, categories: tsCategories, payments: tsPayments, status: tsStatus };
        }

        function updateUI() {
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('kpi-revenue').innerText = fmt.format(stats.revenue);
            document.getElementById('kpi-sales').innerText = stats.sales;
            document.getElementById('kpi-ticket').innerText = fmt.format(stats.avgTicket);
            document.getElementById('kpi-category').innerText = stats.topCategory;
            document.getElementById('kpi-growth').innerText = `${currentData.length} registros`;

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            currentData.slice(-5).reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium">${row.date}</td><td class="p-4 text-gray-500 dark:text-gray-400">${row.product}</td><td class="p-4 text-right font-bold text-gray-700 dark:text-gray-200">${fmt.format(row.value)}</td>`;
                tbody.appendChild(tr);
            });
            
            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';
            stats.topProducts.forEach(prod => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium text-gray-700 dark:text-gray-200">${prod.name}</td><td class="p-4 text-right text-xs text-gray-500 dark:text-gray-400">${prod.qty} un</td><td class="p-4 text-right font-bold text-indigo-600 dark:text-indigo-400">${fmt.format(prod.total)}</td>`;
                topBody.appendChild(tr);
            });

            renderDashboardCharts();
            updateForecastView('general');
        }

        function renderDashboardCharts() {
            updateChartsTheme();
            const commonOptions = { responsive: true, maintainAspectRatio: false, layout: { padding: 10 }, plugins: { legend: { labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { size: 12 } } } } };

            const dates = Object.keys(stats.dailySales).sort();
            const values = dates.map(d => stats.dailySales[d]);
            
            initChart('lineChart', 'line', {
                labels: dates,
                datasets: [{ label: 'Vendas', data: values, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }]
            }, { ...commonOptions, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5], color: (ctx) => ctx.chart.options.borderColor } }, x: { grid: { display: false } } } });

            initChart('paymentChart', 'bar', {
                labels: Object.keys(stats.payBreakdown),
                datasets: [{ label: 'Qtd', data: Object.values(stats.payBreakdown), backgroundColor: ['#3b82f6', '#14b8a6', '#f43f5e'], borderRadius: 4 }]
            }, { ...commonOptions, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { borderDash: [5, 5], color: (ctx) => ctx.chart.options.borderColor } } } });

            initChart('barChart', 'bar', {
                labels: Object.keys(stats.catBreakdown),
                datasets: [{ label: 'R$', data: Object.values(stats.catBreakdown), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6'], borderRadius: 4 }]
            }, { ...commonOptions, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { borderDash: [5, 5], color: (ctx) => ctx.chart.options.borderColor } }, y: { grid: { display: false } } } });

            // MUDANÇA REALIZADA: Doughnut em vez de Radar/Polar
            initChart('doughnutChart', 'doughnut', {
                labels: Object.keys(stats.statusBreakdown),
                datasets: [{ 
                    label: 'Pedidos', 
                    data: Object.values(stats.statusBreakdown), 
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], // Verde, Amarelo, Vermelho
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            }, { 
                ...commonOptions, 
                cutout: '70%', 
                plugins: { legend: { position: 'right', labels: { usePointStyle: true } } } 
            });
        }

        function updateForecastView(type) {
            document.querySelectorAll('.forecast-btn').forEach(btn => {
                if(btn.dataset.type === type) {
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                } else {
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                }
            });
            const dates = timeSeriesData.dates || [];
            if(!dates.length) return;
            const datasets = [];
            
            if (type === 'general') {
                const values = dates.map(d => stats.dailySales[d] || 0);
                const forecast = calculateForecast(dates, values);
                datasets.push(createForecastDataset('Geral', values, forecast, '#6366f1'));
            } else {
                let sourceData = type === 'categories' ? timeSeriesData.categories : (type === 'payments' ? timeSeriesData.payments : timeSeriesData.status);
                const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
                Object.keys(sourceData).slice(0,4).forEach((key, i) => {
                    const values = dates.map(d => sourceData[key][d] || 0);
                    const forecast = calculateForecast(dates, values);
                    datasets.push(createForecastDataset(key, values, forecast, colors[i]));
                });
            }
            initChart('forecastChart', 'line', { labels: [...dates, ...getFutureDates(dates[dates.length-1], 7)], datasets: datasets.flat() }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { borderDash: [5,5], color: (ctx) => ctx.chart.options.borderColor } }, x: { grid: { display: false } } } });
        }

        function createForecastDataset(label, hist, future, color) {
            const padNull = Array(7).fill(null);
            const padHist = Array(hist.length).fill(null);
            padHist[hist.length-1] = hist[hist.length-1];
            return [{ label: label, data: [...hist, ...padNull], borderColor: color, backgroundColor: color, tension: 0.3, pointRadius: 2 },
                    { label: label + ' (Prev)', data: [...padHist, ...future], borderColor: color, borderDash: [5,5], pointStyle: 'rectRot' }];
        }
        function getFutureDates(last, days) { const d = new Date(last); const res = []; for(let i=1; i<=days; i++) { d.setDate(d.getDate()+1); res.push(d.toISOString().split('T')[0]); } return res; }
        function calculateForecast(dates, values) {
            const n = values.length; if(n<2) return Array(7).fill(0);
            const x = Array.from({length: n}, (_, i) => i);
            const sumX = x.reduce((a,b)=>a+b,0), sumY = values.reduce((a,b)=>a+b,0), sumXY = x.reduce((a,i)=>a+i*values[i],0), sumXX = x.reduce((a,i)=>a+i*i,0);
            const slope = (n*sumXY - sumX*sumY)/(n*sumXX - sumX*sumX), intercept = (sumY - slope*sumX)/n;
            const res = []; for(let i=1; i<=7; i++) res.push(Math.max(0, slope*(n-1+i) + intercept)); return res;
        }

        function initChart(id, type, data, options) {
            const canvas = document.getElementById(id); if(!canvas) return;
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(canvas.getContext('2d'), { type, data, options });
        }

        // Chat & AI
        function toggleChatPanel() { document.getElementById('ai-chat-panel').classList.toggle('translate-x-full'); }
        async function analyzeSpecificChart(type) { 
            if(!currentData.length) return showToast("Carregue dados primeiro", "info");
            document.getElementById('ai-chat-panel').classList.remove('translate-x-full');
            const questions = {
                'sales_trend': 'Analise a tendência de vendas diárias.',
                'payment_methods': 'Analise a distribuição de pagamentos.',
                'category_performance': 'Analise o desempenho das categorias.',
                'order_status': 'Analise o status dos pedidos.'
            };
            document.getElementById('chat-input').value = questions[type];
            await sendChatMessage(stats);
        }
        async function sendChatMessage(ctx = null) {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text && !ctx) return;
            if(!apiKey) return showToast("Configure sua API Key primeiro!", "error");

            const history = document.getElementById('chat-history');
            history.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
            input.value = ''; history.scrollTop = history.scrollHeight;
            const loadingId = 'load'+Date.now();
            history.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-ai italic"><i class="fa-solid fa-circle-notch fa-spin"></i> ...</div>`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Analista ERP. Contexto: ${JSON.stringify(ctx || stats)}. Pergunta: "${text}". Responda curto em PT-BR markdown.` }] }] })
                });
                if(!response.ok) throw new Error("API Error");
                const data = await response.json();
                document.getElementById(loadingId).remove();
                history.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(data.candidates[0].content.parts[0].text)}</div>`;
                history.scrollTop = history.scrollHeight;
            } catch(e) { document.getElementById(loadingId).innerText = "Erro: Verifique sua Chave API."; }
        }
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key==='Enter') sendChatMessage(); });
    </script>
</body>
</html>
