<!DOCTYPE html>
<html lang="pt-BR" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ERP Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Inicialização do Tailwind CSS (mantida no head para evitar FOUC)
        const initTailwind = () => {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    darkMode: 'class',
                    theme: {
                        extend: {
                            colors: {
                                slate: { 850: '#1e293b', 950: '#020617' }
                            }
                        }
                    }
                };
            } else {
                setTimeout(initTailwind, 50);
            }
        };
        initTailwind();
    </script>
    <!-- Bibliotecas via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Biblioteca para manipulação de datas (melhoria de robustez) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    
    <!-- Ícones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .trans-all { transition: all 0.3s ease-in-out; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* Chat Styles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        .chat-user { background-color: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #f1f5f9; border: 1px solid #e2e8f0; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        .dark .chat-ai { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }
        .dark .chat-ai strong { color: #818cf8; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 16px; border-radius: 8px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateX(120%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 12px; border-left: 4px solid; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }
        .toast-info { border-color: #3b82f6; }
        .dark .toast { background: #1e293b; color: white; }

        /* Animation */
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .btn-shine { background: linear-gradient(to right, #4f46e5 20%, #818cf8 40%, #818cf8 60%, #4f46e5 80%); background-size: 200% auto; animation: shine 4s linear infinite; }

        /* Print CSS - O Mágico do PDF */
        @media print {
            aside, header, #ai-chat-panel, .no-print { display: none !important; }
            body, main { overflow: visible !important; height: auto !important; background: white !important; color: black !important; }
            .card, .bg-white { box-shadow: none !important; border: 1px solid #ddd !important; break-inside: avoid; }
            #view-dashboard { display: block !important; padding: 0 !important; }
            /* Ajuste para caber gráficos na folha */
            canvas { max-height: 250px !important; } 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-950 dark:text-gray-100 trans-all overflow-hidden">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform">
            <h3 class="text-xl font-bold mb-4 text-indigo-600 dark:text-indigo-400"><i class="fa-solid fa-gear mr-2"></i> Configurações do Sistema</h3>
            
            <div class="space-y-4">
                <!-- API Key -->
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Chave API Gemini (Consultor IA)</label>
                    <input type="password" id="api-key-input" placeholder="Cole sua chave AIza..." class="w-full p-3 border border-gray-300 dark:border-slate-700 rounded-lg mt-1 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Necessário para usar o Consultor IA. Fica salvo apenas no seu navegador.</p>
                </div>

                <!-- Meta Mensal -->
                <div>
                    <label for="monthly-goal-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Meta Mensal de Receita (R$)</label>
                    <input type="number" id="monthly-goal-input" placeholder="Ex: 100000" class="w-full p-3 border border-gray-300 dark:border-slate-700 rounded-lg mt-1 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Usado para calcular o progresso e gamificação.</p>
                </div>

                <!-- Validação: Valor Mínimo -->
                <div>
                    <label for="min-value-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor Mínimo de Transação (R$)</label>
                    <input type="number" id="min-value-input" placeholder="Ex: 0.01" step="0.01" class="w-full p-3 border border-gray-300 dark:border-slate-700 rounded-lg mt-1 bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Transações abaixo deste valor serão marcadas como erro na validação.</p>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeConfigModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button onclick="saveConfig()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salvar Configurações</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        
        <!-- SIDEBAR -->
        <aside class="w-20 md:w-64 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col flex-shrink-0 z-20 trans-all shadow-lg print:hidden">
            <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-gray-100 dark:border-slate-800">
                <div class="flex items-center gap-3 text-indigo-600 dark:text-indigo-400 font-bold text-xl">
                    <i class="fa-solid fa-layer-group text-2xl"></i>
                    <span class="hidden md:block">Nexus ERP</span>
                </div>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:text-indigo-600 dark:hover:text-indigo-400 rounded-xl trans-all group active-nav">
                    <i class="fa-solid fa-chart-line text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Visão Geral</span>
                </button>
                
                <button onclick="switchView('forecast')" id="nav-forecast" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600 dark:hover:text-purple-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-crystal-ball text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Previsões Futuras</span>
                </button>

                <button onclick="toggleChatPanel()" class="w-full flex items-center gap-4 px-4 py-3 text-gray-500 dark:text-gray-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl trans-all group">
                    <i class="fa-solid fa-robot text-lg group-hover:scale-110 trans-all"></i>
                    <span class="hidden md:block font-medium">Consultor IA</span>
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100 dark:border-slate-800">
                <div class="bg-indigo-50 dark:bg-slate-800 p-4 rounded-xl hidden md:block">
                    <p class="text-xs font-semibold text-indigo-900 dark:text-indigo-200 mb-1">Status do Sistema</p>
                    <div class="flex items-center gap-2 text-green-600 dark:text-green-400 text-xs font-bold">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        Online
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 relative">
            
            <!-- TOP BAR -->
            <header class="h-auto md:h-16 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 flex flex-col md:flex-row items-center justify-between px-6 py-2 md:py-0 trans-all z-10 gap-2 print:hidden">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-gray-700 dark:text-gray-100 hidden md:block">Visão Geral</h2>
                    
                    <!-- FILTROS DE DATA -->
                    <div class="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-1">
                        <button onclick="filterByDate(7)" id="btn-7d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700 shadow-sm">7 Dias</button>
                        <button onclick="filterByDate(30)" id="btn-30d" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-slate-700">30 Dias</button>
                        <button onclick="filterByDate('all')" id="btn-all" class="filter-btn px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-sm">Todos</button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Config -->
                    <button onclick="openConfigModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-800 trans-all" title="Configurações do Sistema">
                        <i class="fa-solid fa-gear"></i>
                    </button>

                    <!-- Theme -->
                    <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-yellow-400 hover:ring-2 ring-indigo-500 trans-all">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </button>
                    
                    <!-- Print -->
                    <button onclick="window.print()" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 trans-all" title="Imprimir Relatório">
                        <i class="fa-solid fa-print"></i>
                    </button>

                    <!-- Data Load -->
                    <div class="relative">
                        <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileUpload(this)" class="hidden">
                        <button onclick="document.getElementById('csv-file-input').click()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 trans-all">
                            <i class="fa-solid fa-file-csv mr-2"></i> CSV
                        </button>
                        <button onclick="loadSampleData()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 dark:bg-slate-700 dark:text-gray-200 dark:hover:bg-slate-600 trans-all ml-2">
                            <i class="fa-solid fa-flask mr-2"></i> Exemplo
                        </button>
                    </div>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 scrollbar-hide">
                
                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="view-panel grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- Meta Mensal -->
                    <div class="lg:col-span-4 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400">Meta Mensal de Receita</h4>
                            <p id="monthly-goal-display" class="text-xl font-bold text-gray-800 dark:text-gray-100">R$ 0,00</p>
                        </div>
                        <div class="mt-3">
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-3">
                                <div id="goal-progress-bar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <p class="text-green-600 dark:text-green-400 font-medium" id="goal-progress-text">0% Atingido</p>
                                <p class="text-gray-500 dark:text-gray-400" id="goal-remaining-text">R$ 0,00 Restante</p>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Receita Total</p>
                            <h3 id="kpi-revenue" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mt-1">R$ 0,00</h3>
                            <p id="kpi-growth" class="text-xs text-gray-400 mt-1">0 registros</p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Volume de Vendas</p>
                            <h3 id="kpi-sales" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0</h3>
                            <p class="text-xs text-gray-400 mt-1">Total de transações</p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Ticket Médio</p>
                            <h3 id="kpi-ticket" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mt-1">R$ 0,00</h3>
                            <p class="text-xs text-gray-400 mt-1">Média por transação</p>
                        </div>
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Top Categoria</p>
                            <h3 id="kpi-category" class="text-2xl font-bold text-pink-600 dark:text-pink-400 mt-1">-</h3>
                            <p class="text-xs text-gray-400 mt-1">Em volume de vendas</p>
                        </div>
                    </div>

                    <!-- GRÁFICO DE LINHA - Vendas Diárias -->
                    <div class="lg:col-span-3 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Tendência de Vendas Diárias <span id="sales-trend-filter" class="text-base font-normal text-gray-500 dark:text-gray-400"></span></h4>
                            <button onclick="analyzeSpecificChart('sales_trend')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE DONUT - Status dos Pedidos -->
                    <div class="lg:col-span-1 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Status dos Pedidos</h4>
                            <button onclick="analyzeSpecificChart('order_status')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80 flex items-center justify-center">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE BARRA - Desempenho por Categoria -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Desempenho por Categoria (R$)</h4>
                            <button onclick="analyzeSpecificChart('category_performance')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICO DE BARRA - Métodos de Pagamento -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Métodos de Pagamento (Qtd)</h4>
                            <button onclick="analyzeSpecificChart('payment_methods')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">Insight <i class="fa-solid fa-robot ml-1"></i></button>
                        </div>
                        <div class="h-80">
                            <canvas id="paymentChart"></canvas>
                        </div>
                    </div>

                    <!-- TABELA - Top Produtos -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <h4 class="text-lg font-semibold mb-4">Top 5 Produtos</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsBody" class="bg-white dark:bg-slate-900 divide-y divide-gray-100 dark:divide-slate-800">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TABELA - Transações Recentes -->
                    <div class="lg:col-span-2 card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                        <h4 class="text-lg font-semibold mb-4">Transações Recentes</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody" class="bg-white dark:bg-slate-900 divide-y divide-gray-100 dark:divide-slate-800">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- FORECAST VIEW -->
                <div id="view-forecast" class="view-panel hidden">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="card bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-gray-100 dark:border-slate-800">
                            <h4 class="text-lg font-semibold mb-4" id="forecast-title">Previsão de Vendas (Próximos 7 Dias)</h4>
                            
                            <!-- Filtros de Previsão -->
                            <div class="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-1 mb-4 w-fit">
                                <button onclick="updateForecastView('general')" data-type="general" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors bg-white dark:bg-slate-700 text-purple-600 dark:text-purple-300 shadow-sm">Geral</button>
                                <button onclick="updateForecastView('categories')" data-type="categories" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Categoria</button>
                                <button onclick="updateForecastView('payments')" data-type="payments" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Pagamento</button>
                                <button onclick="updateForecastView('status')" data-type="status" class="forecast-btn px-3 py-1 text-xs font-medium rounded-md transition-colors text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-700">Por Status</button>
                            </div>

                            <div class="h-96">
                                <canvas id="forecastChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- AI CHAT PANEL -->
        <div id="ai-chat-panel" class="fixed right-0 top-0 h-full w-80 bg-white dark:bg-slate-900 shadow-2xl z-30 transform translate-x-full transition-transform duration-300 flex flex-col print:hidden">
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-slate-800">
                <h3 class="text-lg font-bold text-blue-600 dark:text-blue-400"><i class="fa-solid fa-robot mr-2"></i> Consultor IA</h3>
                <button onclick="toggleChatPanel()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div id="chat-history" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-3 scrollbar-hide">
                <div class="chat-bubble chat-ai">Olá! Sou o seu assistente de BI. Carregue seus dados e me pergunte sobre tendências, anomalias ou previsões.</div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-slate-800">
                <div class="flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="Pergunte sobre seus dados..." class="flex-1 p-3 border border-gray-300 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <button onclick="sendChatMessage()" class="w-10 h-10 flex items-center justify-center bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Variáveis de estado globais
        const DEFAULT_CONFIG = {
            geminiApiKey: 'SUA_CHAVE_AQUI',
            monthlyGoal: 100000,
            minValue: 0.01
        };
        let config = JSON.parse(localStorage.getItem('nexusConfig')) || DEFAULT_CONFIG;
        
        let fullData = [];
        let currentData = [];
        let stats = {};
        let timeSeriesData = {};
        const charts = {};
        let chartTheme = {};
        let currentView = 'dashboard';
        let lastValidation = null; // Para guardar o relatório de validação

        // --- DATASET VALIDATOR CLASS ---
        class DatasetValidator {
            static validate(rawData, currentConfig) {
                const map = DatasetValidator.mapColumns(rawData[0] ? Object.keys(rawData[0]) : []);
                const values = rawData.map(d => map.value ? parseFloat(d[map.value]) : parseFloat(d.valor || d.value || 0)).filter(v => !isNaN(v));
                
                // Estatísticas para Outliers
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const stdDev = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / values.length);
                const zScoreLimit = 3; // 3 desvios padrão

                const result = {
                    valid: [],
                    invalid: [],
                    warnings: [],
                    duplicates: [],
                    summary: { total: rawData.length, valid: 0, invalid: 0, warnings: 0, successRate: '0%' }
                };

                const seen = new Set();

                rawData.forEach((d, index) => {
                    const rowIndex = index + 1;
                    const errors = [];
                    const warnings = [];
                    
                    // 1. Normalização e Validação de Colunas
                    const dateStr = map.date ? d[map.date] : (d.data || d.date || d.Data);
                    let date = luxon.DateTime.fromISO(dateStr);
                    if (!date.isValid) {
                        date = luxon.DateTime.fromFormat(dateStr, 'dd/MM/yyyy');
                    }
                    
                    const valueRaw = map.value ? d[map.value] : (d.valor || d.value || 0);
                    const value = parseFloat(valueRaw);

                    const normalized = {
                        date: date.isValid ? date.toISODate() : null,
                        category: map.category ? d[map.category] : (d.categoria || d.category || 'Geral'),
                        product: map.product ? d[map.product] : (d.produto || d.product || 'Item'),
                        value: isNaN(value) ? 0 : value,
                        payment: map.payment ? d[map.payment] : (d.pagamento || d.payment || 'Outros'),
                        status: map.status ? d[map.status] : (d.status || 'Concluído')
                    };

                    // 2. Validação de Data
                    if (!normalized.date) {
                        errors.push(`Data inválida ou não encontrada: "${dateStr}"`);
                    }

                    // 3. Validação de Valor (usando config dinâmica)
                    const minValue = currentConfig.minValue || 0.01;
                    if (isNaN(normalized.value) || normalized.value < minValue) {
                        errors.push(`Valor inválido ou abaixo do mínimo configurado (R$ ${minValue.toFixed(2)}): "${valueRaw}"`);
                    }

                    // 4. Validação de Pagamento (se configurado)
                    if (config.allowedPayments && !config.allowedPayments.includes(normalized.payment)) {
                        warnings.push(`Método de pagamento não padrão: "${normalized.payment}"`);
                    }

                    // 5. Validação de Outlier (aviso)
                    if (stdDev > 0 && Math.abs(normalized.value - mean) / stdDev > zScoreLimit) {
                        warnings.push(`Valor atípico (Outlier) detectado: R$ ${normalized.value.toFixed(2)}`);
                        result.outliers.push({ rowIndex, original: d, value: normalized.value });
                    }

                    // 6. Validação de Duplicata (aviso)
                    const key = `${normalized.date}-${normalized.product}-${normalized.value}`;
                    if (seen.has(key)) {
                        warnings.push(`Registro duplicado (mesma data, produto e valor)`);
                        result.duplicates.push({ rowIndex, original: d });
                    }
                    seen.add(key);

                    // 7. Classificação
                    if (errors.length > 0) {
                        result.invalid.push({ rowIndex, original: d, errors });
                    } else {
                        result.valid.push(normalized);
                        if (warnings.length > 0) {
                            result.warnings.push({ rowIndex, original: d, warnings });
                        }
                    }
                });

                // 8. Sumário
                result.summary.valid = result.valid.length;
                result.summary.invalid = result.invalid.length;
                result.summary.warnings = result.warnings.length + result.duplicates.length + result.outliers.length;
                const successRate = result.summary.total > 0 ? (result.summary.valid / result.summary.total) * 100 : 0;
                result.summary.successRate = `${successRate.toFixed(1)}%`;

                return result;
            }

            static mapColumns(headers) {
                return {
                    date: headers.find(h => /data|date|dt_venda|criado_em|time/i.test(h)) || null,
                    category: headers.find(h => /categoria|category|cat|setor|grupo/i.test(h)) || null,
                    product: headers.find(h => /produto|product|item|mercadoria|nome|descrição|cliente|customer/i.test(h)) || null,
                    value: headers.find(h => /valor|value|total|price|preço|amount|venda|custo/i.test(h)) || null,
                    payment: headers.find(h => /pagamento|payment|pgto|forma|metodo/i.test(h)) || null,
                    status: headers.find(h => /status|estado|situacao|situação/i.test(h)) || null
                };
            }
        }

        // --- UTILS (Theme, Toast, API Key) ---
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            }
            updateChartsTheme(); // Chama a função de charts diretamente
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            if (type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-500"></i>';
            else if (type === 'error') icon = '<i class="fa-solid fa-circle-xmark text-red-500"></i>';
            else icon = '<i class="fa-solid fa-circle-info text-blue-500"></i>';

            toast.innerHTML = `${icon} <span class="text-sm">${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- UTILS (Theme, Toast, Config) ---
        function openConfigModal() {
            document.getElementById('api-key-input').value = config.geminiApiKey === DEFAULT_CONFIG.geminiApiKey ? '' : config.geminiApiKey;
            document.getElementById('monthly-goal-input').value = config.monthlyGoal;
            document.getElementById('min-value-input').value = config.minValue;
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        function saveConfig() {
            const newConfig = {
                geminiApiKey: document.getElementById('api-key-input').value.trim() || DEFAULT_CONFIG.geminiApiKey,
                monthlyGoal: parseFloat(document.getElementById('monthly-goal-input').value) || DEFAULT_CONFIG.monthlyGoal,
                minValue: parseFloat(document.getElementById('min-value-input').value) || DEFAULT_CONFIG.minValue
            };

            config = newConfig;
            localStorage.setItem('nexusConfig', JSON.stringify(config));
            
            showToast("Configurações salvas com sucesso!", "success");
            closeConfigModal();
            updateDashboardUI(); // Atualiza a UI para refletir a nova meta
        }

        // --- VALIDATION REPORT UI ---
        function showValidationReport(validation) {
            lastValidation = validation; // Salva para download
            const existingReport = document.getElementById('validation-report');
            if (existingReport) existingReport.remove();

            const report = document.createElement('div');
            report.id = 'validation-report';
            report.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm';
            
            report.innerHTML = `
                <div class="bg-white dark:bg-slate-900 p-0 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white z-10">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">Relatório de Validação</h2>
                                <p class="text-indigo-100 text-sm mt-1">Análise completa dos dados importados</p>
                            </div>
                            <button onclick="closeValidationReport()" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total</p>
                            <p class="text-3xl font-bold text-gray-800 dark:text-white">${validation.summary.total}</p>
                        </div>
                        <div class="card bg-green-50 dark:bg-green-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-green-600">Válidos</p>
                            <p class="text-3xl font-bold text-green-700 dark:text-green-400">${validation.summary.valid}</p>
                        </div>
                        <div class="card bg-red-50 dark:bg-red-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-red-600">Inválidos</p>
                            <p class="text-3xl font-bold text-red-700 dark:text-red-400">${validation.summary.invalid}</p>
                        </div>
                        <div class="card bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl text-center">
                            <p class="text-sm text-yellow-600">Avisos</p>
                            <p class="text-3xl font-bold text-yellow-700 dark:text-yellow-400">${validation.summary.warnings}</p>
                        </div>
                    </div>

                    <!-- Taxa de Sucesso -->
                    <div class="px-6 pb-4">
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-indigo-700 dark:text-indigo-300">Taxa de Aprovação</span>
                                <span class="text-2xl font-bold text-indigo-800 dark:text-indigo-200">${validation.summary.successRate}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-3">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-1000" style="width: ${validation.summary.successRate}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Erros -->
                    ${validation.invalid.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500 p-4 rounded">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-circle-xmark text-red-600 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-red-800 dark:text-red-300 mb-2">
                                            ${validation.invalid.length} Erro(s) Encontrado(s)
                                        </h3>
                                        <div class="space-y-2 max-h-48 overflow-y-auto">
                                            ${validation.invalid.slice(0, 5).map(row => `
                                                <div class="bg-white dark:bg-slate-800 p-3 rounded text-sm">
                                                    <p class="font-bold text-red-700 dark:text-red-400">Linha ${row.rowIndex}:</p>
                                                    <ul class="mt-1 space-y-1 text-red-600 dark:text-red-300">
                                                        ${row.errors.map(err => `<li class="text-xs">• ${err}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            `).join('')}
                                            ${validation.invalid.length > 5 ? `
                                                <p class="text-center text-xs text-gray-500 dark:text-gray-400 pt-2">
                                                    ... e mais ${validation.invalid.length - 5} erros
                                                </p>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Avisos -->
                    ${validation.warnings.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-yellow-500 p-4 rounded">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-yellow-800 dark:text-yellow-300 mb-2">
                                            ${validation.warnings.length} Aviso(s)
                                        </h3>
                                        <div class="space-y-1 max-h-32 overflow-y-auto">
                                            ${validation.warnings.slice(0, 3).map(row => `
                                                <p class="text-xs text-yellow-700 dark:text-yellow-300">
                                                    Linha ${row.rowIndex}: ${row.warnings.join(', ')}
                                                </p>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Duplicatas -->
                    ${validation.duplicates.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-orange-50 dark:bg-orange-900/10 border-l-4 border-orange-500 p-4 rounded">
                                <h3 class="font-bold text-orange-800 dark:text-orange-300 mb-2">
                                    <i class="fa-solid fa-copy mr-2"></i>
                                    ${validation.duplicates.length} Duplicata(s) Detectada(s)
                                </h3>
                                <p class="text-xs text-orange-600 dark:text-orange-300">
                                    Registros com mesma data, produto e valor
                                </p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Outliers -->
                    ${validation.outliers.length > 0 ? `
                        <div class="px-6 pb-4">
                            <div class="bg-purple-50 dark:bg-purple-900/10 border-l-4 border-purple-500 p-4 rounded">
                                <h3 class="font-bold text-purple-800 dark:text-purple-300 mb-2">
                                    <i class="fa-solid fa-chart-line mr-2"></i>
                                    ${validation.outliers.length} Outlier(s) Detectado(s)
                                </h3>
                                <p class="text-xs text-purple-600 dark:text-purple-300">
                                    Valores estatisticamente atípicos - verifique se estão corretos
                                </p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Footer -->
                    <div class="sticky bottom-0 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-700 p-6 flex gap-3 z-10">
                        <button onclick="downloadErrorReport()" class="flex-1 px-4 py-3 bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors font-medium">
                            <i class="fa-solid fa-download mr-2"></i>
                            Baixar Relatório
                        </button>
                        <button onclick="closeValidationReport()" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">
                            <i class="fa-solid fa-check mr-2"></i>
                            Continuar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(report);
        }

        function closeValidationReport() {
            const report = document.getElementById('validation-report');
            if (report) report.remove();
        }

        function downloadErrorReport() {
            if (!lastValidation) return;
            
            const validation = lastValidation;
            let csvContent = "Linha,Tipo,Mensagem,Dados Originais\n";

            // Adicionar erros
            validation.invalid.forEach(row => {
                row.errors.forEach(error => {
                    csvContent += `${row.rowIndex},ERRO,"${error}","${JSON.stringify(row.original).replace(/"/g, '""')}"\n`;
                });
            });

            // Adicionar avisos
            validation.warnings.forEach(row => {
                row.warnings.forEach(warning => {
                    csvContent += `${row.rowIndex},AVISO,"${warning}","${JSON.stringify(row.original).replace(/"/g, '""')}"\n`;
                });
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `relatorio_validacao_${luxon.DateTime.now().toISODate()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast("Relatório baixado!", "success");
        }

        // --- DATA (Loading, Processing, Filtering) ---

        // Helper para determinar o formato da data
        function getDateFormat() {
            if (fullData.length === 0) return 'dd/MM';
            
            const years = new Set(fullData.map(d => luxon.DateTime.fromISO(d.date).year));
            
            // Se houver mais de um ano, mostra o ano.
            if (years.size > 1) {
                return 'dd/MM/yyyy';
            }
            // Caso contrário, mostra apenas dia e mês.
            return 'dd/MM';
        }
        function mapColumns(headers) {
            return DatasetValidator.mapColumns(headers); // Reutiliza o mapeamento da classe
        }

        function loadSampleData() {
            const sample = [];
            const categories = ['Eletrônicos', 'Móveis', 'Serviços', 'Software', 'Acessórios'];
            const products = {
                'Eletrônicos': ['Notebook Dell', 'Monitor 24"', 'Mouse Gamer', 'Teclado Mecânico'],
                'Móveis': ['Cadeira Ergonomica', 'Mesa de Canto', 'Sofá 2L', 'Estante'],
                'Serviços': ['Instalação', 'Garantia Extra', 'Consultoria', 'Manutenção'],
                'Software': ['Windows Pro', 'Antivirus', 'Office 365', 'Adobe CC'],
                'Acessórios': ['Cabo HDMI', 'Hub USB', 'Mousepad', 'Suporte Notebook']
            };
            const methods = ['Crédito', 'PIX', 'Boleto'];
            
            // Usando Luxon para datas
            let date = luxon.DateTime.now().minus({ days: 30 });
            
            for(let i=0; i<=30; i++) {
                const dailySales = Math.floor(Math.random() * 8) + 1; 
                for(let j=0; j<dailySales; j++) {
                    const cat = categories[Math.floor(Math.random() * categories.length)];
                    const prodList = products[cat];
                    const prod = prodList[Math.floor(Math.random() * prodList.length)];
                    const priceBase = Math.random() * 500 + 50;
                    
                    sample.push({
                        date: date.toISODate(),
                        category: cat,
                        product: prod,
                        value: parseFloat((priceBase * (1 + i/50)).toFixed(2)),
                        payment: methods[Math.floor(Math.random() * methods.length)],
                        status: Math.random() > 0.1 ? 'Concluído' : (Math.random() > 0.3 ? 'Pendente' : 'Devolvido')
                    });
                }
                date = date.plus({ days: 1 });
            }
            
            // Simula a validação para dados de exemplo (todos válidos)
            const validation = {
                valid: sample,
                invalid: [],
                warnings: [],
                duplicates: [],
                outliers: [],
                summary: { total: sample.length, valid: sample.length, invalid: 0, warnings: 0, successRate: '100%' }
            };

            processData(validation.valid);
            showToast("Dados de exemplo carregados!", "success");
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            showToast("Validando arquivo...", "info");

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    
                    // Usa a configuração dinâmica do usuário
                    const validation = DatasetValidator.validate(results.data, config);

                    showValidationReport(validation);

                    // Se tiver dados válidos, processar
                    if (validation.valid.length > 0) {
                        processData(validation.valid);
                        showToast(
                            `✅ ${validation.valid.length} registros importados com sucesso!`,
                            "success"
                        );
                    }

                    // Se tiver muitos erros, alertar
                    if (validation.summary.invalid > validation.summary.valid) {
                        showToast(
                            `⚠️ ${validation.summary.invalid} registros rejeitados. Verifique o arquivo!`,
                            "error"
                        );
                    }
                },
                error: function(err) {
                    showToast(`Erro ao processar CSV: ${err.message}`, "error");
                }
            });
        }

        function processData(data) {
            fullData = data.sort((a,b) => luxon.DateTime.fromISO(a.date).toMillis() - luxon.DateTime.fromISO(b.date).toMillis());
            filterByDate('all');
        }

        function filterByDate(days) {
            let filterText = '';
            let forecastTitle = 'Previsão de Vendas (Próximos 7 Dias)'; // Default
            
            if (days === 7) {
                filterText = '(Últimos 7 Dias)';
            } else if (days === 30) {
                filterText = '(Últimos 30 Dias)';
                forecastTitle = 'Previsão de Vendas (Próximos 30 Dias)';
            } else {
                filterText = '(Todos os Dados)';
                forecastTitle = 'Previsão de Vendas (Próximos 7 Dias)'; // Mantém 7 dias para "Todos"
            }

            document.getElementById('sales-trend-filter').innerText = filterText;
            document.getElementById('forecast-title').innerText = forecastTitle;
            const today = luxon.DateTime.now().startOf('day');
            let startDate = null;

            if (days === 'all') {
                currentData = [...fullData];
            } else {
                startDate = today.minus({ days: days - 1 });
                currentData = fullData.filter(d => luxon.DateTime.fromISO(d.date) >= startDate);
            }
            
            // Atualiza o estado dos botões de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                btn.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-slate-700');
            });
            const activeBtn = document.getElementById(`btn-${days}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-indigo-600', 'dark:text-indigo-400', 'shadow-sm');
                activeBtn.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-white', 'dark:hover:bg-slate-700');
            }

            calculateStats();
            updateDashboardUI();
        }

        function calculateStats() {
            const totalRev = currentData.reduce((sum, item) => sum + item.value, 0);
            const counts = {};
            const payments = {};
            const statusCount = {};
            const dateMap = {};
            const productSales = {}; 
            
            const tsCategories = {}; const tsPayments = {}; const tsStatus = {};
            const uniqueDates = [...new Set(currentData.map(d => d.date))].sort();

            currentData.forEach(d => {
                counts[d.category] = (counts[d.category] || 0) + d.value;
                payments[d.payment] = (payments[d.payment] || 0) + 1;
                statusCount[d.status] = (statusCount[d.status] || 0) + 1;
                dateMap[d.date] = (dateMap[d.date] || 0) + d.value;
                
                if(!productSales[d.product]) productSales[d.product] = { qty: 0, total: 0 };
                productSales[d.product].qty += 1;
                productSales[d.product].total += d.value;

                if(!tsCategories[d.category]) tsCategories[d.category] = {}; tsCategories[d.category][d.date] = (tsCategories[d.category][d.date] || 0) + d.value;
                if(!tsPayments[d.payment]) tsPayments[d.payment] = {}; tsPayments[d.payment][d.date] = (tsPayments[d.payment][d.date] || 0) + d.value;
                if(!tsStatus[d.status]) tsStatus[d.status] = {}; tsStatus[d.status][d.date] = (tsStatus[d.status][d.date] || 0) + 1;
            });

            const fillZeros = (obj) => { uniqueDates.forEach(date => { if(!obj[date]) obj[date] = 0; }); return obj; };
            Object.values(tsCategories).forEach(fillZeros); Object.values(tsPayments).forEach(fillZeros); Object.values(tsStatus).forEach(fillZeros);

            const topCat = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
            const topProducts = Object.entries(productSales).map(([name, data]) => ({ name, ...data })).sort((a,b) => b.total - a.total).slice(0, 5);

            stats = {
                revenue: totalRev,
                sales: currentData.length,
                avgTicket: currentData.length ? totalRev / currentData.length : 0,
                topCategory: topCat,
                catBreakdown: counts,
                payBreakdown: payments,
                statusBreakdown: statusCount,
                dailySales: dateMap,
                topProducts: topProducts
            };
            timeSeriesData = { dates: uniqueDates, categories: tsCategories, payments: tsPayments, status: tsStatus };
        }

        // --- CHARTS (Rendering, Forecasting) ---
        function updateChartsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const color = isDark ? '#e2e8f0' : '#334155';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            chartTheme = {
                color: color,
                gridColor: gridColor,
                font: { family: 'Inter', size: 12 },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                    titleColor: color,
                    bodyColor: color,
                    borderColor: isDark ? '#475569' : '#cbd5e1',
                    borderWidth: 1,
                }
            };

            // Re-render all charts with new theme
            Object.values(charts).forEach(chart => {
                chart.options.color = chartTheme.color;
                chart.options.scales.y.ticks.color = chartTheme.color;
                chart.options.scales.x.ticks.color = chartTheme.color;
                chart.options.scales.y.grid.color = chartTheme.gridColor;
                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = chartTheme.gridColor;
                chart.options.plugins.tooltip = chartTheme.tooltip;
                chart.update();
            });
        }

        function initChart(id, type, data, options) {
            const canvas = document.getElementById(id); 
            if(!canvas) return;
            if(charts[id]) charts[id].destroy();
            
            const ctx = canvas.getContext('2d');
            
            // Merge common options with specific options
            const commonOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                layout: { padding: 10 }, 
                color: chartTheme.color,
                font: chartTheme.font,
                plugins: { 
                    legend: { 
                        labels: { 
                            usePointStyle: true, 
                            boxWidth: 8, 
                            padding: 20, 
                            font: chartTheme.font,
                            color: chartTheme.color
                        } 
                    },
                    tooltip: chartTheme.tooltip
                },
                scales: {
                    y: {
                        ticks: { color: chartTheme.color },
                        grid: { borderDash: [5, 5], color: chartTheme.gridColor }
                    },
                    x: {
                        ticks: { color: chartTheme.color },
                        grid: { display: false }
                    }
                }
            };

            charts[id] = new Chart(ctx, { 
                type, 
                data, 
                options: Chart.helpers.merge(commonOptions, options) 
            });
        }

        function renderDashboardCharts() {
            updateChartsTheme();

            const dates = Object.keys(stats.dailySales).sort();
            const values = dates.map(d => stats.dailySales[d]);
            
            const dateFormat = getDateFormat();
            initChart('lineChart', 'line', {
                labels: dates,
                datasets: [{ label: 'Vendas', data: values, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }]
            }, { 
                scales: { 
                    y: { beginAtZero: true }, 
                    x: { 
                        grid: { display: false },
                        ticks: {
                            callback: function(value, index, ticks) {
                                // Formata a data para o formato DD/MM ou DD/MM/YYYY
                                return luxon.DateTime.fromISO(this.getLabelForValue(value)).toFormat(dateFormat);
                            }
                        }
                    } 
                } 
            });

            initChart('paymentChart', 'bar', {
                labels: Object.keys(stats.payBreakdown),
                datasets: [{ label: 'Qtd', data: Object.values(stats.payBreakdown), backgroundColor: ['#3b82f6', '#14b8a6', '#f43f5e'], borderRadius: 4 }]
            }, { 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { grid: { display: false } }, 
                    y: { beginAtZero: true } 
                } 
            });

            initChart('barChart', 'bar', {
                labels: Object.keys(stats.catBreakdown),
                datasets: [{ label: 'R$', data: Object.values(stats.catBreakdown), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6'], borderRadius: 4 }]
            }, { 
                indexAxis: 'y', 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { grid: { borderDash: [5, 5], color: chartTheme.gridColor } }, 
                    y: { grid: { display: false } } 
                } 
            });

            initChart('doughnutChart', 'doughnut', {
                labels: Object.keys(stats.statusBreakdown),
                datasets: [{ 
                    label: 'Pedidos', 
                    data: Object.values(stats.statusBreakdown), 
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], // Verde, Amarelo, Vermelho
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            }, { 
                cutout: '70%', 
                plugins: { legend: { position: 'right', labels: { usePointStyle: true } } } 
            });
        }

        function getFutureDates(last, days) { 
            const d = luxon.DateTime.fromISO(last); 
            const res = []; 
            for(let i=1; i<=days; i++) { 
                res.push(d.plus({ days: i }).toISODate()); 
            } 
            return res; 
        }

        function calculateForecast(dates, values) {
            const n = values.length; 
            if(n<2) return Array(7).fill(0);
            const x = Array.from({length: n}, (_, i) => i);
            const sumX = x.reduce((a,b)=>a+b,0), sumY = values.reduce((a,b)=>a+b,0), sumXY = x.reduce((a,i)=>a+i*values[i],0), sumXX = x.reduce((a,i)=>a+i*i,0);
            
            // Regressão Linear Simples
            const slope = (n*sumXY - sumX*sumY)/(n*sumXX - sumX*sumX);
            const intercept = (sumY - slope*sumX)/n;
            
            const res = []; 
            for(let i=1; i<=7; i++) {
                // Previsão para os próximos 7 dias
                res.push(Math.max(0, slope*(n-1+i) + intercept)); 
            }
            return res;
        }

        function createForecastDataset(label, hist, future, color) {
            const padNull = Array(7).fill(null);
            const padHist = Array(hist.length).fill(null);
            padHist[hist.length-1] = hist[hist.length-1];
            return [{ 
                label: label, 
                data: [...hist, ...padNull], 
                borderColor: color, 
                backgroundColor: color, 
                tension: 0.3, 
                pointRadius: 2,
                segment: {
                    borderColor: ctx => ctx.p0.parsed.y === null ? 'transparent' : color,
                }
            },
            { 
                label: label + ' (Prev)', 
                data: [...padHist, ...future], 
                borderColor: color, 
                borderDash: [5,5], 
                pointStyle: 'rectRot',
                backgroundColor: 'transparent',
                pointRadius: 4,
                pointHoverRadius: 6
            }];
        }

        function updateForecastView(type) {
            document.querySelectorAll('.forecast-btn').forEach(btn => {
                if(btn.dataset.type === type) {
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                } else {
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                    btn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-purple-600', 'dark:text-purple-300', 'shadow-sm');
                }
            });

            const dates = timeSeriesData.dates || [];
            if(!dates.length) return;
            const datasets = [];

            if (type === 'general') {
                const values = dates.map(d => stats.dailySales[d] || 0);
                const forecast = calculateForecast(dates, values);
                datasets.push(createForecastDataset('Geral', values, forecast, '#6366f1'));
            } else {
                let sourceData = type === 'categories' ? timeSeriesData.categories : (type === 'payments' ? timeSeriesData.payments : timeSeriesData.status);
                const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
                Object.keys(sourceData).slice(0,4).forEach((key, i) => {
                    const values = dates.map(d => sourceData[key][d] || 0);
                    const forecast = calculateForecast(dates, values);
                    datasets.push(createForecastDataset(key, values, forecast, colors[i]));
                });
            }

            const forecastDateFormat = getDateFormat();
            initChart('forecastChart', 'line', { 
                labels: [...dates, ...getFutureDates(dates[dates.length-1], 7)], 
                datasets: datasets.flat() 
            }, { 
                scales: { 
                    y: { beginAtZero: true }, 
                    x: { 
                        grid: { display: false },
                        ticks: {
                            callback: function(value, index, ticks) {
                                // Formata a data para o formato DD/MM ou DD/MM/YYYY
                                return luxon.DateTime.fromISO(this.getLabelForValue(value)).toFormat(forecastDateFormat);
                            }
                        }
                    } 
                } 
            });
        }

        // --- AI (Chat, Analysis) ---
        function toggleChatPanel() { 
            document.getElementById('ai-chat-panel').classList.toggle('translate-x-full'); 
        }

        async function analyzeSpecificChart(type) { 
            if(!stats.sales) return showToast("Carregue dados primeiro", "info");
            
            document.getElementById('ai-chat-panel').classList.remove('translate-x-full');
            const questions = {
                'sales_trend': 'Analise a tendência de vendas diárias.',
                'payment_methods': 'Analise a distribuição de pagamentos.',
                'category_performance': 'Analise o desempenho das categorias.',
                'order_status': 'Analise o status dos pedidos.'
            };
            document.getElementById('chat-input').value = questions[type];
            await sendChatMessage(stats);
        }

        async function sendChatMessage(ctx = null) {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if(!text && !ctx) return;
            if(config.geminiApiKey === DEFAULT_CONFIG.geminiApiKey) return showToast("Configure sua API Key primeiro nas Configurações!", "error");

            const history = document.getElementById('chat-history');
            history.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
            input.value = ''; 
            history.scrollTop = history.scrollHeight;
            
            const loadingId = 'load'+Date.now();
            history.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-ai italic"><i class="fa-solid fa-circle-notch fa-spin"></i> ...</div>`;
            history.scrollTop = history.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.geminiApiKey}`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ 
                            parts: [{ 
                                text: `Você é um Analista de ERP. Seu objetivo é fornecer insights rápidos e práticos para um empresário. O contexto dos dados é: ${JSON.stringify(ctx || aiContext)}. A pergunta do usuário é: "${text}". Responda de forma concisa em português do Brasil, usando Markdown.` 
                            }] 
                        }] 
                    })
                });
                
                if(!response.ok) throw new Error("API Error");
                const data = await response.json();
                
                document.getElementById(loadingId).remove();
                
                // Usando marked para renderizar o Markdown da resposta da IA
                const aiResponse = data.candidates[0].content.parts[0].text;
                history.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(aiResponse)}</div>`;
                history.scrollTop = history.scrollHeight;
            } catch(e) { 
                document.getElementById(loadingId).innerText = "Erro: Verifique sua Chave API ou a conexão."; 
                showToast("Erro na comunicação com a API do Gemini.", "error");
            }
        }

        // --- UI (View Switching, Dashboard Update) ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-nav', 'bg-indigo-600', 'text-white', 'dark:bg-indigo-700', 'dark:text-white');
                item.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-indigo-50', 'dark:hover:bg-indigo-900/20', 'hover:text-indigo-600', 'dark:hover:text-indigo-400');
            });

            const activeNav = document.getElementById(`nav-${view}`);
            if (activeNav) {
                activeNav.classList.add('active-nav', 'bg-indigo-600', 'text-white', 'dark:bg-indigo-700', 'dark:text-white');
                activeNav.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:bg-indigo-50', 'dark:hover:bg-indigo-900/20', 'hover:text-indigo-600', 'dark:hover:text-indigo-400');
            }

            const title = view === 'dashboard' ? 'Visão Geral' : 'Previsões Futuras';
            document.getElementById('page-title').innerText = title;

            // Atualiza o conteúdo da view
            if (view === 'dashboard') {
                updateDashboardUI();
            } else if (view === 'forecast') {
                updateForecastView('general');
            }
        }

        function updateDashboardUI() {
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            
            // --- GAMIFICATION / META MENSAL ---
            const goal = config.monthlyGoal;
            const revenue = stats.revenue;
            const progress = goal > 0 ? Math.min(100, (revenue / goal) * 100) : 0;
            const remaining = Math.max(0, goal - revenue);

            document.getElementById('monthly-goal-display').innerText = fmt.format(goal);
            document.getElementById('goal-progress-bar').style.width = `${progress}%`;
            document.getElementById('goal-progress-text').innerText = `${progress.toFixed(1)}% Atingido`;
            document.getElementById('goal-remaining-text').innerText = `${fmt.format(remaining)} Restante`;

            // Update KPIs
            document.getElementById('kpi-revenue').innerText = fmt.format(revenue);
            document.getElementById('kpi-sales').innerText = stats.sales;
            document.getElementById('kpi-ticket').innerText = fmt.format(stats.avgTicket);
            document.getElementById('kpi-category').innerText = stats.topCategory;
            document.getElementById('kpi-growth').innerText = `${currentData.length} registros`;

            // Update Recent Transactions Table
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            currentData.slice(-5).reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium">${row.date}</td><td class="p-4 text-gray-500 dark:text-gray-400">${row.product}</td><td class="p-4 text-right font-bold text-gray-700 dark:text-gray-200">${fmt.format(row.value)}</td>`;
                tbody.appendChild(tr);
            });
            
            // Update Top Products Table
            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';
            stats.topProducts.forEach(prod => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 trans-all";
                tr.innerHTML = `<td class="p-4 font-medium text-gray-700 dark:text-gray-200">${prod.name}</td><td class="p-4 text-right text-xs text-gray-500 dark:text-gray-400">${prod.qty} un</td><td class="p-4 text-right font-bold text-indigo-600 dark:text-indigo-400">${fmt.format(prod.total)}</td>`;
                topBody.appendChild(tr);
            });

            renderDashboardCharts();
            if (currentView === 'forecast') {
                updateForecastView('general');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            
            // Carrega dados de exemplo na inicialização
            loadSampleData();

            // Listener para o input do chat
            document.getElementById('chat-input').addEventListener('keypress', (e) => { 
                if(e.key==='Enter') sendChatMessage(); 
            });
            
            // Atualiza a UI com as configurações iniciais
            updateDashboardUI();
        });
    </script>
</body>
</html>
