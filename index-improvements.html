<!-- =====================================================================
     MELHORIAS PARA ADICIONAR AO index.html
     ===================================================================== -->

<!-- 1. ADICIONAR ESSAS BIBLIOTECAS NO <head> (AP√ìS Chart.js) -->

<!-- Simple Statistics para c√°lculos estat√≠sticos -->
<script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

<!-- 2. ADICIONAR ESSES SCRIPTS ANTES DE FECHAR </head> -->

<!-- Melhorias e corre√ß√µes -->
<script src="nexus-improvements.js" defer></script>

<!-- Gr√°ficos avan√ßados -->
<script src="advanced-charts.js" defer></script>

<!-- =====================================================================
     3. ADICIONAR ESSAS SE√á√ïES NO DASHBOARD
     ===================================================================== -->

<!-- Adicionar ap√≥s o doughnutChart, dentro de view-dashboard -->

<!-- Nova se√ß√£o: Gr√°ficos Avan√ßados -->
<div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Scatter Plot -->
    <div class="card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">
                <i class="fa-solid fa-chart-scatter text-indigo-600 mr-2"></i>
                An√°lise de Dispers√£o
            </h3>
            <button onclick="analyzeSpecificChart('scatter')" class="px-3 py-1 text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Analisar
            </button>
        </div>
        <div class="chart-container h-80">
            <canvas id="scatterChart"></canvas>
        </div>
    </div>

    <!-- Box Plot -->
    <div class="card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">
                <i class="fa-solid fa-chart-column text-purple-600 mr-2"></i>
                Distribui√ß√£o por Categoria
            </h3>
            <button onclick="analyzeSpecificChart('boxplot')" class="px-3 py-1 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Analisar
            </button>
        </div>
        <div class="chart-container h-80">
            <canvas id="boxPlotChart"></canvas>
        </div>
    </div>

    <!-- Radar Chart -->
    <div class="card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">
                <i class="fa-solid fa-chart-radar text-pink-600 mr-2"></i>
                An√°lise Multivariada
            </h3>
            <button onclick="analyzeSpecificChart('radar')" class="px-3 py-1 text-xs bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 rounded-lg hover:bg-pink-200 dark:hover:bg-pink-900/50 transition-colors">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Analisar
            </button>
        </div>
        <div class="chart-container h-80">
            <canvas id="radarChart"></canvas>
        </div>
    </div>

    <!-- Heatmap -->
    <div class="card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">
                <i class="fa-solid fa-fire text-orange-600 mr-2"></i>
                Mapa de Calor (Correla√ß√µes)
            </h3>
            <button onclick="analyzeSpecificChart('heatmap')" class="px-3 py-1 text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Analisar
            </button>
        </div>
        <div class="chart-container h-80">
            <canvas id="heatmapChart"></canvas>
        </div>
    </div>
</div>

<!-- =====================================================================
     4. ADICIONAR ESSAS FUN√á√ïES NO <script> FINAL
     ===================================================================== -->

<script>
    // Renderizar novos gr√°ficos ap√≥s carregar dados
    const originalRenderDashboardCharts = window.renderDashboardCharts;
    window.renderDashboardCharts = function() {
        // Chamar fun√ß√£o original
        originalRenderDashboardCharts.call(this);

        // Renderizar novos gr√°ficos
        if (typeof currentData !== 'undefined' && currentData.length > 0) {
            try {
                // Scatter Plot
                if (typeof createScatterChart === 'function') {
                    createScatterChart('scatterChart', currentData);
                }

                // Box Plot
                if (typeof createBoxPlotChart === 'function') {
                    createBoxPlotChart('boxPlotChart', currentData);
                }

                // Radar Chart
                if (typeof createRadarChart === 'function') {
                    createRadarChart('radarChart', currentData);
                }

                // Heatmap
                if (typeof createHeatmapChart === 'function') {
                    createHeatmapChart('heatmapChart', currentData);
                }

                console.log('‚úÖ Gr√°ficos avan√ßados renderizados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao renderizar gr√°ficos avan√ßados:', error);
                window.showToast?.('Erro ao renderizar alguns gr√°ficos', 'error');
            }
        }
    };

    // Melhorar an√°lise de gr√°ficos espec√≠ficos
    const originalAnalyzeSpecificChart = window.analyzeSpecificChart;
    window.analyzeSpecificChart = async function(type) {
        let context = '';

        switch(type) {
            case 'scatter':
                context = `An√°lise de Dispers√£o: Mostra a rela√ß√£o entre categorias e valores. Padr√µes podem indicar correla√ß√µes ou anomalias.`;
                break;
            case 'boxplot':
                context = `An√°lise de Distribui√ß√£o: Mostra mediana, quartis e outliers por categoria. √ötil para entender variabilidade.`;
                break;
            case 'radar':
                context = `An√°lise Multivariada: Compara m√∫ltiplas m√©tricas (Total, M√©dia, M√°ximo, Contagem) entre categorias.`;
                break;
            case 'heatmap':
                context = `Mapa de Calor: Mostra correla√ß√£o entre categorias e m√©todos de pagamento. Cores mais intensas = valores maiores.`;
                break;
            default:
                return originalAnalyzeSpecificChart?.call(this, type);
        }

        // Enviar para IA
        if (typeof sendChatMessage === 'function') {
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = `Analise este gr√°fico de ${type}: ${context}. Quais insights voc√™ pode extrair dos dados?`;
                await sendChatMessage();
            }
        }
    };

    // Valida√ß√£o melhorada ao carregar CSV
    const originalHandleFileUpload = window.handleFileUpload;
    window.handleFileUpload = function(input) {
        const file = input?.files?.[0];
        if (!file) return;

        // Valida√ß√£o de tipo
        const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'text/plain'];
        const fileName = file.name.toLowerCase();

        if (!allowedTypes.includes(file.type) && !fileName.endsWith('.csv')) {
            window.showToast?.('Formato inv√°lido! Use apenas arquivos .CSV', 'error');
            input.value = '';
            return;
        }

        // Validar tamanho (m√°x 10MB)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            window.showToast?.('Arquivo muito grande! M√°ximo 10MB', 'error');
            input.value = '';
            return;
        }

        // Chamar fun√ß√£o original
        try {
            originalHandleFileUpload.call(this, input);
        } catch (error) {
            window.showToast?.(`Erro ao processar arquivo: ${error.message}`, 'error');
        }
    };

    // Limpeza de mem√≥ria ao trocar de view
    const originalSwitchView = window.switchView;
    window.switchView = function(view) {
        // Limpar gr√°ficos antigos
        if (typeof cleanupMemory === 'function') {
            cleanupMemory();
        }

        // Chamar fun√ß√£o original
        return originalSwitchView.call(this, view);
    };

    // Monitoramento de performance
    window.addEventListener('load', () => {
        if (typeof PerformanceMonitor !== 'undefined') {
            const report = PerformanceMonitor.getReport();
            console.log('üìä Performance Report:', report);
        }
    });

    // Verifica√ß√£o de acessibilidade
    window.addEventListener('load', () => {
        if (typeof AccessibilityChecker !== 'undefined') {
            const issues = AccessibilityChecker.check();
            if (issues.length > 0) {
                console.warn('‚ö†Ô∏è Problemas de acessibilidade encontrados');
            }
        }
    });
</script>

<!-- =====================================================================
     5. ADICIONAR ESSAS MELHORIAS AO CSS
     ===================================================================== -->

<style>
    /* Melhorias para gr√°ficos avan√ßados */
    .chart-container {
        position: relative;
        min-height: 300px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(139, 92, 246, 0.02));
        border-radius: 12px;
        padding: 8px;
    }

    .chart-container canvas {
        transition: opacity 0.3s ease;
    }

    /* Melhorias para cards */
    .card {
        border: 1px solid rgba(99, 102, 241, 0.1);
        transition: all 0.3s ease;
    }

    .card:hover {
        border-color: rgba(99, 102, 241, 0.3);
        box-shadow: 0 12px 30px -8px rgba(99, 102, 241, 0.2);
    }

    .dark .card {
        border-color: rgba(99, 102, 241, 0.2);
    }

    .dark .card:hover {
        border-color: rgba(99, 102, 241, 0.4);
        box-shadow: 0 12px 30px -8px rgba(99, 102, 241, 0.3);
    }

    /* Loading skeleton para gr√°ficos */
    .chart-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
    }

    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Responsividade melhorada */
    @media (max-width: 768px) {
        .chart-container {
            min-height: 250px;
        }

        .grid.grid-cols-1.lg\\:grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }
</style>
